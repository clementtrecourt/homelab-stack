This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.repomix/
  bundles.json
ansible/
  group_vars/
    all/
      vault.yml
    all.yml
  provisioning/
    adguard.yml
    configure_proxmox.yml
    nginx.yml
    servarr.yml
  roles/
    common/
      handlers/
        main.yml
      meta/
        main.yml
      tasks/
        docker.yml
        main.yml
      tests/
        inventory
        test.yml
      vars/
        main.yml
      README.md
    users/
      defaults/
        main.yml
      tasks/
        main.yml
  ansible.cfg
  inventory.tf.ini
  README.md
  site.yml
docker-compose/
  lxc-100-adguard/
    conf/
      AdGuardHome.tpl
    .gitignore
    docker-compose.yml
    README.md
  lxc-101-servarr/
    budget/
      public/
        index.html
      Dockerfile
      package.json
      server.js
    .env
    .gitignore
    docker-compose.yml
    old-vpn.yml
    README.md
  lxc-102-reverse-proxy/
    .gitignore
    docker-compose.yml
    README.md
  lxc-203-jenkins/
    docker-compose.yml
    Dockerfile
kubernetes/
  README.md
scripts/
  backup_orchestrator.sh
  README.md
terraform/
  .terraform/
    providers/
      registry.terraform.io/
        hashicorp/
          local/
            2.6.1/
              linux_amd64/
                LICENSE.txt
                terraform-provider-local_v2.6.1_x5
        telmate/
          proxmox/
            3.0.2-rc04/
              linux_amd64/
                LICENSE
                README.md
                terraform-provider-proxmox_v3.0.2-rc04
  .gitignore
  inventory.tpl
  main.tf
  terraform.tfstate.backup
  variables.tf
.gitignore
Jenkinsfile
README.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".repomix/bundles.json">
{
  "bundles": {
    "test-567": {
      "name": "test",
      "created": "2025-11-18T19:23:18.795Z",
      "lastUsed": "2025-11-18T19:23:18.795Z",
      "tags": [],
      "files": []
    }
  }
}
</file>

<file path="ansible/provisioning/nginx.yml">
---
- name: Deploy Nginx
  hosts: nginx
  gather_facts: no
  tasks:
    - name: Start the Nginx stack with Docker Compose
      community.docker.docker_compose_v2:
        project_src: '/opt/homelab-stack/docker-compose/lxc-102-reverse-proxy'
        state: present
</file>

<file path="ansible/roles/common/meta/main.yml">
#SPDX-License-Identifier: MIT-0
galaxy_info:
  author: your name
  description: your role description
  company: your company (optional)

  # If the issue tracker for your role is not on github, uncomment the
  # next line and provide a value
  # issue_tracker_url: http://example.com/issue/tracker

  # Choose a valid license ID from https://spdx.org - some suggested licenses:
  # - BSD-3-Clause (default)
  # - MIT
  # - GPL-2.0-or-later
  # - GPL-3.0-only
  # - Apache-2.0
  # - CC-BY-4.0
  license: license (GPL-2.0-or-later, MIT, etc)

  min_ansible_version: 2.2

  # If this a Container Enabled role, provide the minimum Ansible Container version.
  # min_ansible_container_version:

  galaxy_tags: []
    # List tags for your role here, one per line. A tag is a keyword that describes
    # and categorizes the role. Users find roles by searching for tags. Be sure to
    # remove the '[]' above, if you add tags to this list.
    #
    # NOTE: A tag is limited to a single word comprised of alphanumeric characters.
    #       Maximum 20 tags per role.

dependencies: []
  # List your role dependencies here, one per line. Be sure to remove the '[]' above,
  # if you add dependencies to this list.
</file>

<file path="ansible/roles/common/tests/inventory">
#SPDX-License-Identifier: MIT-0
localhost
</file>

<file path="ansible/roles/common/tests/test.yml">
#SPDX-License-Identifier: MIT-0
---
- hosts: localhost
  remote_user: root
  roles:
    - roles/common
</file>

<file path="ansible/roles/common/vars/main.yml">
#SPDX-License-Identifier: MIT-0
---
# vars file for roles/common
</file>

<file path="ansible/roles/common/README.md">
Role Name
=========

A brief description of the role goes here.

Requirements
------------

Any pre-requisites that may not be covered by Ansible itself or the role should be mentioned here. For instance, if the role uses the EC2 module, it may be a good idea to mention in this section that the boto package is required.

Role Variables
--------------

A description of the settable variables for this role should go here, including any variables that are in defaults/main.yml, vars/main.yml, and any variables that can/should be set via parameters to the role. Any variables that are read from other roles and/or the global scope (ie. hostvars, group vars, etc.) should be mentioned here as well.

Dependencies
------------

A list of other roles hosted on Galaxy should go here, plus any details in regards to parameters that may need to be set for other roles, or variables that are used from other roles.

Example Playbook
----------------

Including an example of how to use your role (for instance, with variables passed in as parameters) is always nice for users too:

    - hosts: servers
      roles:
         - { role: username.rolename, x: 42 }

License
-------

BSD

Author Information
------------------

An optional section for the role authors to include contact information, or a website (HTML is not allowed).
</file>

<file path="ansible/roles/users/defaults/main.yml">
---
# defaults file for the users role
default_start_dir: "/opt/homelab-stack/docker-compose"
</file>

<file path="docker-compose/lxc-100-adguard/conf/AdGuardHome.tpl">
http:
  pprof:
    port: 6060
    enabled: false
  address: 0.0.0.0:80
  session_ttl: 720h
users:
  - name: root
    password: ${ADGUARD_PASSWORD_HASH} 
auth_attempts: 5
block_auth_min: 15
http_proxy: ""
language: ""
theme: auto
dns:
  bind_hosts:
    - 0.0.0.0
  port: 53
  anonymize_client_ip: false
  ratelimit: 20
  ratelimit_subnet_len_ipv4: 24
  ratelimit_subnet_len_ipv6: 56
  ratelimit_whitelist: []
  refuse_any: true
  upstream_dns:
    - https://dns10.quad9.net/dns-query
  upstream_dns_file: ""
  bootstrap_dns:
    - 9.9.9.10
    - 149.112.112.10
    - 2620:fe::10
    - 2620:fe::fe:10
  fallback_dns: []
  upstream_mode: load_balance
  fastest_timeout: 1s
  allowed_clients: []
  disallowed_clients: []
  blocked_hosts:
    - version.bind
    - id.server
    - hostname.bind
  trusted_proxies:
    - 127.0.0.0/8
    - ::1/128
  cache_enabled: true
  cache_size: 4194304
  cache_ttl_min: 0
  cache_ttl_max: 0
  cache_optimistic: false
  bogus_nxdomain: []
  aaaa_disabled: false
  enable_dnssec: false
  edns_client_subnet:
    custom_ip: ""
    enabled: false
    use_custom: false
  max_goroutines: 300
  handle_ddr: true
  ipset: []
  ipset_file: ""
  bootstrap_prefer_ipv6: false
  upstream_timeout: 10s
  private_networks: []
  use_private_ptr_resolvers: true
  local_ptr_upstreams: []
  use_dns64: false
  dns64_prefixes: []
  serve_http3: false
  use_http3_upstreams: false
  serve_plain_dns: true
  hostsfile_enabled: true
  pending_requests:
    enabled: true
tls:
  enabled: false
  server_name: ""
  force_https: false
  port_https: 443
  port_dns_over_tls: 853
  port_dns_over_quic: 853
  port_dnscrypt: 0
  dnscrypt_config_file: ""
  allow_unencrypted_doh: false
  certificate_chain: ""
  private_key: ""
  certificate_path: ""
  private_key_path: ""
  strict_sni_check: false
querylog:
  dir_path: ""
  ignored: []
  interval: 2160h
  size_memory: 1000
  enabled: true
  file_enabled: true
statistics:
  dir_path: ""
  ignored: []
  interval: 24h
  enabled: true
filters:
  - enabled: true
    url: https://adguardteam.github.io/HostlistsRegistry/assets/filter_1.txt
    name: AdGuard DNS filter
    id: 1
  - enabled: false
    url: https://adguardteam.github.io/HostlistsRegistry/assets/filter_2.txt
    name: AdAway Default Blocklist
    id: 2
  - enabled: true
    url: https://adguardteam.github.io/HostlistsRegistry/assets/filter_59.txt
    name: AdGuard DNS Popup Hosts filter
    id: 1761983005
  - enabled: true
    url: https://adguardteam.github.io/HostlistsRegistry/assets/filter_49.txt
    name: HaGeZi's Ultimate Blocklist
    id: 1761983006
whitelist_filters: []
user_rules: []
dhcp:
  enabled: false
  interface_name: ""
  local_domain_name: lan
  dhcpv4:
    gateway_ip: ""
    subnet_mask: ""
    range_start: ""
    range_end: ""
    lease_duration: 86400
    icmp_timeout_msec: 1000
    options: []
  dhcpv6:
    range_start: ""
    lease_duration: 86400
    ra_slaac_only: false
    ra_allow_slaac: false
filtering:
  blocking_ipv4: ""
  blocking_ipv6: ""
  blocked_services:
    schedule:
      time_zone: Local
    ids: []
  protection_disabled_until: null
  safe_search:
    enabled: false
    bing: true
    duckduckgo: true
    ecosia: true
    google: true
    pixabay: true
    yandex: true
    youtube: true
  blocking_mode: default
  parental_block_host: family-block.dns.adguard.com
  safebrowsing_block_host: standard-block.dns.adguard.com
  rewrites:
    - domain: '*.local'
      answer: 192.168.1.113
      enabled: true
  safe_fs_patterns:
    - /opt/AdGuardHome/userfilters/*
  safebrowsing_cache_size: 1048576
  safesearch_cache_size: 1048576
  parental_cache_size: 1048576
  cache_time: 30
  filters_update_interval: 24
  blocked_response_ttl: 10
  filtering_enabled: true
  rewrites_enabled: true
  parental_enabled: true
  safebrowsing_enabled: true
  protection_enabled: true
clients:
  runtime_sources:
    whois: true
    arp: true
    rdns: true
    dhcp: true
    hosts: true
  persistent: []
log:
  enabled: true
  file: ""
  max_backups: 0
  max_size: 100
  max_age: 3
  compress: false
  local_time: false
  verbose: false
os:
  group: ""
  user: ""
  rlimit_nofile: 0
schema_version: 31
</file>

<file path="docker-compose/lxc-100-adguard/.gitignore">
# Ignorer le répertoire de travail d'AdGuard
work/

# Ignorer les fichiers système (ex: .DS_Store sur macOS)
.DS_Store
# Ignorer le fichier contenant les secrets
.env

# Ignorer le fichier de configuration généré
conf/AdGuardHome.yaml
</file>

<file path="docker-compose/lxc-100-adguard/README.md">
# Service AdGuard Home

Ce dossier contient la configuration pour déployer le service de filtrage DNS [AdGuard Home](https://adguard.com/fr/adguard-home/overview.html) via Docker Compose.

## Rôle

AdGuard Home fournit un service de filtrage DNS pour tout le réseau domestique, bloquant les publicités et les traqueurs. Il sert également de serveur DNS local.

## Configuration Requise

Ce service gère son mot de passe de manière sécurisée en utilisant un template et une variable d'environnement.

1.  Créez un fichier `.env` à la racine de ce dossier.
2.  Ajoutez-y la variable suivante avec le hash de votre mot de passe (généré par AdGuard ou via `htpasswd`) :

    ```env
    # .env
    ADGUARD_PASSWORD_HASH='votre_hash_ici'
    ```

Le fichier `docker-compose.yml` utilise ensuite ce template pour générer le fichier de configuration final au démarrage du conteneur.

## Déploiement

```bash
docker-compose up -d
```

## Accès

*   **Interface Web** : `http://<IP_DU_LXC>:PORT` (selon les ports que vous avez mappés pour l'UI).
*   **Serveur DNS** : `<IP_DU_LXC>` sur le port `53`.
</file>

<file path="docker-compose/lxc-101-servarr/budget/public/index.html">
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Gestionnaire de Dépenses</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        :root { --background-color: #f4f7f9; --main-text-color: #1f2937; --card-background: #ffffff; --primary-color: #3b82f6; --primary-color-dark: #2563eb; --green-color: #10b981; --red-color: #ef4444; --border-color: #e5e7eb; --shadow-color: rgba(0, 0, 0, 0.05); } 
        body { font-family: 'Poppins', sans-serif; background-color: var(--background-color); color: var(--main-text-color); margin: 0; padding: 20px; } 
        .container { max-width: 1200px; margin: 0 auto; } 
        h1, h2, h3 { margin-top: 0; } 
        header { display: flex; justify-content: flex-end; align-items: center; text-align: center; margin-bottom: 40px; } 
        header h1 { font-weight: 700; font-size: 2.5rem; } 
        .total-container { background: linear-gradient(45deg, var(--primary-color), var(--primary-color-dark)); color: white; padding: 40px; text-align: center; border-radius: 16px; margin-bottom: 40px; box-shadow: 0 10px 20px rgba(59, 130, 246, 0.2); } 
        .total-container h2 { font-weight: 500; font-size: 1.2rem; opacity: 0.9; margin-bottom: 10px; } 
        .total-amount { font-size: 3.5rem; font-weight: 700; } 
        .accounts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-bottom: 40px; } 
        .account { background-color: var(--card-background); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; box-shadow: 0 4px 12px var(--shadow-color); transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease; } 
        .account:hover { transform: translateY(-5px); box-shadow: 0 8px 16px var(--shadow-color); } 
        .account-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; } 
        .account-header h3 { margin: 0; font-size: 1.25rem; } 
        .account-header-icons { display: flex; align-items: center; }
        .account-header-icons i { color: #9ca3af; cursor: pointer; transition: color 0.2s; margin-left: 12px; font-size: 1rem; } 
        .btn-edit-account-name:hover, .btn-toggle-visibility:hover { color: var(--primary-color); } 
        .btn-delete-account:hover { color: var(--red-color); } 
        .account-balance { font-weight: 600; font-size: 1.75rem; margin-bottom: 20px;} 
        .balance-positive { color: var(--green-color); } 
        .balance-negative { color: var(--red-color); } 
        table { width: 100%; border-collapse: collapse; } 
        th { text-align: left; padding: 10px 0; color: #6b7280; font-weight: 500; font-size: 0.9rem; border-bottom: 1px solid var(--border-color); } 
        td { padding: 14px 0; border-bottom: 1px solid var(--border-color); } 
        tr:last-child td { border-bottom: none; } 
        .action-buttons button { background: none; border: none; cursor: pointer; font-size: 1rem; margin-left: 15px; color: #9ca3af; transition: color 0.2s; } 
        .btn-edit:hover { color: #f59e0b; } 
        .btn-delete:hover { color: var(--red-color); } 
        .form-section { background-color: var(--card-background); border: 1px solid var(--border-color); padding: 30px; border-radius: 12px; } 
        .form-section h2 { margin-bottom: 20px; } 
        .form-group { margin-bottom: 15px; } 
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; } 
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; } 
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); } 
        .submit-button, .button-secondary { background-color: var(--primary-color); color: white; padding: 12px 20px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .submit-button:hover { background-color: var(--primary-color-dark); }
        .button-secondary { background-color: #e5e7eb; color: var(--main-text-color); }
        .button-secondary:hover { background-color: #d1d5db; }
        .is-hidden { opacity: 0.5; }
        .is-hidden h3, .is-hidden .account-balance, .is-hidden td { text-decoration: line-through; }
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--card-background); border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; width: 90%; max-width: 500px; }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 1.8rem; font-weight: bold; line-height: 1; color: #9ca3af; background: none; border: none; cursor: pointer; padding: 5px; }
        .modal-close-btn:hover { color: var(--main-text-color); }

        /* --- NOUVEAU : Styles pour l'affichage du solde partagé --- */
        .balance-wrapper {
            display: flex;
            align-items: center;
            gap: 18px; /* Espace entre les montants et la barre */
            margin-bottom: 20px;
            justify-content: space-between;
        }
        .balance-separator {
            border-left: 2px solid #d1d5db; /* Ligne verticale grise */
            height: 35px; /* Hauteur de la ligne */
        }
        .shared-balance {
            font-size: 1.5rem; /* Taille de police légèrement plus petite */
            font-weight: 500;
            opacity: 0.8; /* Légèrement moins visible */
            color: rgba(0, 0, 0, 0.932);
        }
        /* On retire la marge du bas pour les soldes qui sont dans le wrapper */
        .balance-wrapper .account-balance {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button id="open-add-account-modal-btn" class="button-secondary"><i class="fas fa-plus"></i> Ajouter un compte</button>
        </header>
        <div class="total-container">
            <h2>Solde Total (Visible)</h2>
            <p id="total-amount" class="total-amount">0,00 €</p>
        </div>
        <div id="accounts-grid" class="accounts-grid"></div>
        <div class="form-section">
            <h2>Ajouter une transaction</h2>
            <form id="add-transaction-form">
                <div class="form-group">
                    <label for="description">Description</label>
                    <input type="text" id="description" placeholder="Ex: Facture d'électricité" required>
                </div>
                <div class="form-group">
                    <label for="amount">Montant</label>
                    <input type="number" id="amount" placeholder="Utilisez '-' pour une dépense" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="account-select">Compte</label>
                    <select id="account-select" required></select>
                </div>
                <button type="submit" class="submit-button"><i class="fas fa-plus"></i> Ajouter la transaction</button>
            </form>
        </div>
    </div>

    <div id="add-account-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="modal-close-btn">&times;</button>
            <div class="form-section">
                <h2>Ajouter un compte</h2>
                <form id="add-account-form">
                    <div class="form-group">
                        <label for="new-account-name">Nom du nouveau compte</label>
                        <input type="text" id="new-account-name" placeholder="Ex: Livret A" required>
                    </div>
                    <button type="submit" class="submit-button"><i class="fas fa-wallet"></i> Créer le compte</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let state = { accounts: [] };
        const totalAmountEl = document.getElementById('total-amount');
        const accountsGridEl = document.getElementById('accounts-grid');
        const addTransactionForm = document.getElementById('add-transaction-form');
        const descriptionInput = document.getElementById('description');
        const amountInput = document.getElementById('amount');
        const accountSelect = document.getElementById('account-select');
        const addAccountForm = document.getElementById('add-account-form');
        const newAccountNameInput = document.getElementById('new-account-name');
        const addAccountModal = document.getElementById('add-account-modal');
        const openAddAccountModalBtn = document.getElementById('open-add-account-modal-btn');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        const API = {
            _request: async (url, options = {}) => { let response; try { response = await fetch(url, options); } catch (error) { throw new Error("Erreur de connexion au serveur."); } if (!response.ok) { const errorData = await response.json().catch(() => ({})); throw new Error(errorData.error || `Erreur du serveur (status ${response.status})`); } if (response.status === 204) { return null; } return response.json(); },
            getData: () => API._request('/api/data'),
            addTransaction: (description, amount, accountId) => API._request('/api/transactions', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ description, amount, accountId }) }),
            updateTransaction: (id, description, amount) => API._request(`/api/transactions/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ description, amount }) }),
            deleteTransaction: (id) => API._request(`/api/transactions/${id}`, { method: 'DELETE' }),
            toggleTransactionVisibility: (id, is_hidden) => API._request(`/api/transactions/${id}/toggle-hidden`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ is_hidden }) }),
            addAccount: (name) => API._request('/api/accounts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) }),
            updateAccount: (id, name) => API._request(`/api/accounts/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) }),
            deleteAccount: (id) => API._request(`/api/accounts/${id}`, { method: 'DELETE' }),
            toggleAccountVisibility: (id, is_hidden) => API._request(`/api/accounts/${id}/toggle-hidden`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ is_hidden }) }),
        };

        const formatCurrency = (number) => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(number);

        const render = () => {
            accountsGridEl.innerHTML = '';
            accountSelect.innerHTML = '';
            let grandTotal = 0;
            if (!state.accounts || state.accounts.length === 0) {
                accountsGridEl.innerHTML = "<p>Aucun compte n'a été trouvé. Créez-en un pour commencer !</p>";
                totalAmountEl.textContent = formatCurrency(0);
                accountSelect.disabled = true;
                return;
            }
            accountSelect.disabled = false;

            state.accounts.forEach(account => {
                const accountBalance = account.transactions.reduce((sum, tx) => sum + (tx.is_hidden ? 0 : tx.amount), 0);
                
                if (!account.is_hidden) {
                    grandTotal += accountBalance;
                }

                const accountDiv = document.createElement('div');
                accountDiv.className = `account ${account.is_hidden ? 'is-hidden' : ''}`;

                const transactionsHtml = account.transactions.map(tx => {
                    const visibilityIcon = tx.is_hidden ? 'fa-eye-slash' : 'fa-eye';
                    const visibilityTitle = tx.is_hidden ? 'Rendre visible' : 'Masquer du calcul';
                    return `
                        <tr class="${tx.is_hidden ? 'is-hidden' : ''}">
                            <td>${tx.description}</td>
                            <td class="${tx.amount >= 0 ? 'balance-positive' : 'balance-negative'}">${formatCurrency(tx.amount)}</td>
                            <td class="action-buttons" style="text-align: right;">
                                <button class="btn-toggle-visibility" data-transaction-id="${tx.id}" title="${visibilityTitle}"><i class="fas ${visibilityIcon}"></i></button>
                                <button class="btn-edit" data-transaction-id="${tx.id}" title="Modifier"><i class="fas fa-pencil-alt"></i></button>
                                <button class="btn-delete" data-transaction-id="${tx.id}" title="Supprimer"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>`;
                }).join('');
                
                const accountVisibilityIcon = account.is_hidden ? 'fa-eye-slash' : 'fa-eye';
                const accountVisibilityTitle = account.is_hidden ? 'Rendre visible' : 'Masquer le compte';
                
                // --- MODIFIÉ : On génère le HTML du solde de manière conditionnelle ---
                const balanceClass = accountBalance >= 0 ? 'balance-positive' : 'balance-negative';
                let balanceHtml;

                if (account.name === 'Compte Joint') {
                    const sharedAmount = accountBalance / 2;
                    const sharedBalanceClass = sharedAmount >= 0 ? 'balance-positive' : 'balance-negative';
                    balanceHtml = `
                        <div class="balance-wrapper">
                            <div class="account-balance ${balanceClass}">${formatCurrency(accountBalance)}</div>
                            <div class="balance-separator"></div>
                            <div class="shared-balance ${sharedBalanceClass}">${formatCurrency(sharedAmount)}</div>
                        </div>`;
                } else {
                    balanceHtml = `<div class="account-balance ${balanceClass}">${formatCurrency(accountBalance)}</div>`;
                }
                // --- FIN DE LA MODIFICATION ---

                accountDiv.innerHTML = `
                    <div class="account-header">
                        <h3>${account.name}</h3>
                        <div class="account-header-icons">
                            <i class="fas ${accountVisibilityIcon} btn-toggle-visibility" data-account-id="${account.id}" title="${accountVisibilityTitle}"></i>
                            <i class="fas fa-pencil-alt btn-edit-account-name" data-account-id="${account.id}" title="Modifier le nom"></i>
                            <i class="fas fa-trash-alt btn-delete-account" data-account-id="${account.id}" title="Supprimer le compte"></i>
                        </div>
                    </div>
                    ${balanceHtml} <!-- On insère le HTML du solde généré ici -->
                    <table>
                        <tbody>${transactionsHtml || `<tr><td colspan="3" style="color:#9ca3af;">Aucune transaction.</td></tr>`}</tbody>
                    </table>`;
                accountsGridEl.appendChild(accountDiv);

                const option = document.createElement('option');
                option.value = account.id;
                option.textContent = account.name;
                accountSelect.appendChild(option);
            });
            totalAmountEl.textContent = formatCurrency(grandTotal);
        };
        
        const refreshDataAndRender = async () => { try { const data = await API.getData(); state.accounts = data.accounts; render(); } catch (error) { console.error("Erreur de chargement des données:", error); alert(error.message); accountsGridEl.innerHTML = `<p style="color:red;">Impossible de charger les données.</p>`; } };
        const openModal = () => { addAccountModal.style.display = 'flex'; };
        const closeModal = () => { addAccountModal.style.display = 'none'; };
        openAddAccountModalBtn.addEventListener('click', openModal);
        modalCloseBtn.addEventListener('click', closeModal);
        addAccountModal.addEventListener('click', (event) => { if (event.target === addAccountModal) { closeModal(); } });
        addTransactionForm.addEventListener('submit', async (e) => { e.preventDefault(); if (!accountSelect.value) { alert("Veuillez d'abord créer un compte."); return; } try { await API.addTransaction(descriptionInput.value, parseFloat(amountInput.value), parseInt(accountSelect.value)); addTransactionForm.reset(); await refreshDataAndRender(); } catch (error) { alert(`Erreur: ${error.message}`); } });
        addAccountForm.addEventListener('submit', async (e) => { e.preventDefault(); const newName = newAccountNameInput.value.trim(); if (newName) { try { await API.addAccount(newName); addAccountForm.reset(); closeModal(); await refreshDataAndRender(); } catch (error) { alert(`Erreur: ${error.message}`); } } });

        accountsGridEl.addEventListener('click', async (e) => {
            const editAccountBtn = e.target.closest('.btn-edit-account-name');
            const deleteAccountBtn = e.target.closest('.btn-delete-account');
            const toggleAccountBtn = e.target.closest('[data-account-id].btn-toggle-visibility');
            const editTransactionBtn = e.target.closest('.btn-edit');
            const deleteTransactionBtn = e.target.closest('.btn-delete');
            const toggleTransactionBtn = e.target.closest('[data-transaction-id].btn-toggle-visibility');
            try {
                if (toggleAccountBtn) { const accountId = parseInt(toggleAccountBtn.dataset.accountId); const account = state.accounts.find(acc => acc.id === accountId); await API.toggleAccountVisibility(accountId, account.is_hidden ? 0 : 1); await refreshDataAndRender(); }
                if (toggleTransactionBtn) { const transactionId = parseInt(toggleTransactionBtn.dataset.transactionId); const tx = state.accounts.flatMap(acc => acc.transactions).find(t => t.id === transactionId); await API.toggleTransactionVisibility(transactionId, tx.is_hidden ? 0 : 1); await refreshDataAndRender(); }
                if (editAccountBtn) { const accountId = parseInt(editAccountBtn.dataset.accountId); const account = state.accounts.find(acc => acc.id === accountId); const newName = prompt("Nouveau nom du compte :", account.name); if (newName && newName.trim()) { await API.updateAccount(accountId, newName.trim()); await refreshDataAndRender(); } }
                if (deleteAccountBtn) { const accountId = parseInt(deleteAccountBtn.dataset.accountId); if (confirm('Êtes-vous sûr ? La suppression d\'un compte effacera aussi TOUTES ses transactions.')) { await API.deleteAccount(accountId); await refreshDataAndRender(); } }
                if (deleteTransactionBtn) { const transactionId = parseInt(deleteTransactionBtn.dataset.transactionId); if (confirm('Supprimer cette transaction ?')) { await API.deleteTransaction(transactionId); await refreshDataAndRender(); } }
                if (editTransactionBtn) { const transactionId = parseInt(editTransactionBtn.dataset.transactionId); const tx = state.accounts.flatMap(acc => acc.transactions).find(t => t.id === transactionId); if (tx) { const newDesc = prompt('Nouvelle description :', tx.description); if (newDesc === null) return; const newAmountStr = prompt('Nouveau montant :', tx.amount); if (newAmountStr === null) return; const newAmount = parseFloat(newAmountStr); if (newDesc.trim() && !isNaN(newAmount)) { await API.updateTransaction(transactionId, newDesc.trim(), newAmount); await refreshDataAndRender(); } } }
            } catch (error) { alert(`Erreur: ${error.message}`); }
        });

        document.addEventListener('DOMContentLoaded', refreshDataAndRender);
    </script>
</body>
</html>
</file>

<file path="docker-compose/lxc-101-servarr/budget/Dockerfile">
# Étape 1: Choisir une image de base légère avec Node.js
FROM node:18-alpine

# Étape 2: Définir le répertoire de travail à l'intérieur du conteneur
WORKDIR /app

# Étape 3: Copier les fichiers de dépendances
# On copie ces fichiers en premier pour profiter du cache Docker.
# Si ces fichiers ne changent pas, Docker n'exécutera pas "npm install" à chaque build.
COPY package*.json ./

# Étape 4: Installer les dépendances de l'application
RUN npm install

# Étape 5: Copier tout le reste du code de l'application
COPY . .

# Étape 6: Exposer le port que notre serveur utilise
# CORRIGÉ : Le port exposé correspond maintenant au port du serveur
EXPOSE 2000

# Étape 7: La commande pour démarrer l'application lorsque le conteneur se lance
CMD ["node", "server.js"]
</file>

<file path="docker-compose/lxc-101-servarr/budget/package.json">
{
  "name": "mon-gestionnaire",
  "version": "1.0.0",
  "description": "Un gestionnaire de dépenses simple",
  "main": "server.js",
  "scripts": {
    "start": "node server.js"
  },
  "author": "",
  "license": "ISC",
  "dependencies": {
    "express": "^4.18.2",
    "sqlite3": "^5.1.6"
  }
}
</file>

<file path="docker-compose/lxc-101-servarr/budget/server.js">
// Fichier: server.js (version corrigée et complète)

const express = require('express');
const sqlite3 = require('sqlite3').verbose();
const app = express();
const PORT = 2000;

app.use(express.static('public'));
app.use(express.json());

const dbPath = './data/database.db';
const db = new sqlite3.Database(dbPath, (err) => {
    if (err) {
        console.error("Erreur de connexion à la base de données :", err.message);
    }
    console.log('Connecté à la base de données SQLite.');
});

db.serialize(() => {
    // La colonne "is_hidden" est ajoutée ici
    db.run(`CREATE TABLE IF NOT EXISTS accounts (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        is_hidden INTEGER DEFAULT 0
    )`);
    // Et aussi ici
    db.run(`CREATE TABLE IF NOT EXISTS transactions (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        description TEXT NOT NULL,
        amount REAL NOT NULL,
        account_id INTEGER,
        is_hidden INTEGER DEFAULT 0,
        FOREIGN KEY (account_id) REFERENCES accounts(id) ON DELETE CASCADE
    )`);

    const checkQuery = "SELECT COUNT(*) as count FROM accounts";
    db.get(checkQuery, (err, row) => {
        if (err) {
            console.error("Erreur lors de la vérification des comptes :", err.message);
            return;
        }
        if (row.count === 0) {
            console.log("Base de données vide, création du compte par défaut...");
            db.run("INSERT INTO accounts (name) VALUES (?)", ["Compte Joint"], (err) => {
                if (err) console.error("Erreur lors de la création du compte par défaut :", err.message);
                else console.log("Compte 'Compte Joint' créé avec succès.");
            });
        }
    });
});


// GET /api/data : Obtenir toutes les données
app.get('/api/data', (req, res) => {
    db.all("SELECT * FROM accounts", [], (err, accounts) => {
        if (err) return res.status(500).json({ error: err.message });
        db.all("SELECT * FROM transactions", [], (err, transactions) => {
            if (err) return res.status(500).json({ error: err.message });
            const data = {
                accounts: accounts.map(acc => ({
                    ...acc,
                    transactions: transactions.filter(tx => tx.account_id === acc.id)
                }))
            };
            res.json(data);
        });
    });
});


// --- API POUR LES COMPTES ---
app.post('/api/accounts', (req, res) => {
    const { name } = req.body;
    if (!name || name.trim() === '') return res.status(400).json({ error: "Le nom du compte est requis." });
    const query = `INSERT INTO accounts (name) VALUES (?)`;
    db.run(query, [name.trim()], function(err) {
        if (err) return res.status(500).json({ error: err.message });
        res.status(201).json({ id: this.lastID, name: name.trim(), transactions: [], is_hidden: 0 });
    });
});

app.put('/api/accounts/:id', (req, res) => {
    const { name } = req.body;
    if (!name) return res.status(400).json({ error: "Le nom est requis." });
    const query = `UPDATE accounts SET name = ? WHERE id = ?`;
    db.run(query, [name, req.params.id], function(err) {
        if (err) return res.status(500).json({ error: err.message });
        if (this.changes === 0) return res.status(404).json({ error: "Compte non trouvé."});
        res.json({ message: "Nom du compte mis à jour." });
    });
});

app.delete('/api/accounts/:id', (req, res) => {
    const query = `DELETE FROM accounts WHERE id = ?`;
    db.run(query, req.params.id, function(err) {
        if (err) return res.status(500).json({ error: err.message });
        if (this.changes === 0) return res.status(404).json({ error: "Compte non trouvé."});
        res.json({ message: "Compte supprimé avec succès." });
    });
});

// Route pour masquer/afficher un compte
app.put('/api/accounts/:id/toggle-hidden', (req, res) => {
    const { is_hidden } = req.body;
    if (is_hidden === undefined) return res.status(400).json({ error: "Le statut 'is_hidden' est requis." });
    const query = `UPDATE accounts SET is_hidden = ? WHERE id = ?`;
    db.run(query, [is_hidden, req.params.id], function(err) {
        if (err) return res.status(500).json({ error: err.message });
        if (this.changes === 0) return res.status(404).json({ error: "Compte non trouvé."});
        res.json({ message: "Visibilité du compte mise à jour." });
    });
});


// --- API POUR LES TRANSACTIONS ---
app.post('/api/transactions', (req, res) => {
    const { description, amount, accountId } = req.body;
    if (!description || amount === undefined || !accountId) return res.status(400).json({ error: "Données manquantes." });
    const query = `INSERT INTO transactions (description, amount, account_id) VALUES (?, ?, ?)`;
    db.run(query, [description, amount, accountId], function(err) {
        if (err) return res.status(500).json({ error: err.message });
        res.status(201).json({ id: this.lastID, description, amount, account_id: accountId, is_hidden: 0 });
    });
});

app.put('/api/transactions/:id', (req, res) => {
    const { description, amount } = req.body;
    if (!description || amount === undefined) return res.status(400).json({ error: "Données manquantes." });
    const query = `UPDATE transactions SET description = ?, amount = ? WHERE id = ?`;
    db.run(query, [description, amount, req.params.id], function(err) {
        if (err) return res.status(500).json({ error: err.message });
        if (this.changes === 0) return res.status(404).json({ error: "Transaction non trouvée."});
        res.json({ message: "Transaction mise à jour." });
    });
});

app.delete('/api/transactions/:id', (req, res) => {
    const query = `DELETE FROM transactions WHERE id = ?`;
    db.run(query, req.params.id, function(err) {
        if (err) return res.status(500).json({ error: err.message });
        if (this.changes === 0) return res.status(404).json({ error: "Transaction non trouvée."});
        res.json({ message: "Transaction supprimée." });
    });
});

// Route pour masquer/afficher une transaction
app.put('/api/transactions/:id/toggle-hidden', (req, res) => {
    const { is_hidden } = req.body;
    if (is_hidden === undefined) return res.status(400).json({ error: "Le statut 'is_hidden' est requis." });
    const query = `UPDATE transactions SET is_hidden = ? WHERE id = ?`;
    db.run(query, [is_hidden, req.params.id], function(err) {
        if (err) return res.status(500).json({ error: err.message });
        if (this.changes === 0) return res.status(404).json({ error: "Transaction non trouvée."});
        res.json({ message: "Visibilité de la transaction mise à jour." });
    });
});

app.listen(PORT, () => {
    console.log(`Serveur démarré sur http://localhost:${PORT}`);
});
</file>

<file path="docker-compose/lxc-101-servarr/.env">
# .env
# Ce fichier contient les secrets et la configuration spécifique à l'environnement.
# Il DOIT être listé dans le .gitignore.

# --- Configuration Générale ---
TZ=Europe/Paris
PUID=1000
PGID=1000

# --- Chemins d'accès aux Médias ---
# Pointe vers le dossier racine contenant tous vos médias (films, séries, etc.)
MEDIA_ROOT=/media

# Pointe vers le dossier où qBittorrent télécharge les fichiers.
# Peut être le même que MEDIA_ROOT ou un sous-dossier comme /media/downloads
DOWNLOADS_DIR=/media/data


# --- Secrets VPN ---
VPN_SERVICE_PROVIDER=protonvpn
VPN_TYPE=wireguard
WIREGUARD_PRIVATE_KEY=mGu/wZiJ+Q5UOpdcPATGfszxuHGM5M/WOUbKiL7Q4F4=

# --- Configuration VPN ---
VPN_PORT_FORWARDING=on
PORT_FORWARD_ONLY=on
SERVER_COUNTRIES=France
SERVER_CITIES=Marseille
</file>

<file path="docker-compose/lxc-101-servarr/.gitignore">
# .gitignore

# Ignorer tous les dossiers de configuration et de données des services
# Ces dossiers sont créés par Docker Compose au premier lancement
config/
data/
gluetun/
jellyfin/
jellyseerr/
prowlarr/
qbittorrent/
radarr/
sonarr/

# Pour l'application "budget", ignorer les données et les dépendances
budget/data/
budget/data copy/
budget/node_modules/

# Fichiers système classiques
.DS_Store
</file>

<file path="docker-compose/lxc-101-servarr/old-vpn.yml">
networks:
  servarrnetwork:
    name: servarrnetwork
    ipam:
      config:
        - subnet: 172.39.0.0/24

services:
  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    networks:
      servarrnetwork:
        ipv4_address: 172.39.0.2
    ports:
      # Expose WebUIs for services running through the VPN
      - 8080:8080   # qBittorrent WebUI
      - 9696:9696   # Prowlarr WebUI
      #
      # REMOVED: The static forwarded port line.
      # ProtonVPN's port is dynamic and opened automatically inside the container.
      # You do not need to map it to the host here.
      #
    volumes:
      - ./gluetun:/gluetun
    env_file:
      - .env
    healthcheck:
      test: ping -c 1 www.google.com || exit 1
      interval: 20s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - WEBUI_PORT=8080 # Must match the port exposed in gluetun's service above
    volumes:
      - ./qbittorrent:/config
      - /media/data:/data
    depends_on:
      gluetun:
        condition: service_healthy
    network_mode: service:gluetun

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./prowlarr:/config
    depends_on:
      gluetun:
        condition: service_healthy
    network_mode: service:gluetun


  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./sonarr:/config
      - /media:/media # Sonarr needs to see the same data directory as qBittorrent
    ports:
      - 8989:8989
    networks:
      servarrnetwork:
        ipv4_address: 172.39.0.3

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./radarr:/config
      - /media:/media # Radarr needs to see the same data directory as qBittorrent
    ports:
      - 7878:7878
    networks:
      servarrnetwork:
        ipv4_address: 172.39.0.4
  jellyfin:
    image: lscr.io/linuxserver/jellyfin:latest
    container_name: jellyfin
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Paris
    volumes:
      - ./jellyfin:/config
      - /media:/media
    devices:
      - /dev/dri:/dev/dri #Use for Intel QuickSync
    ports:
      - 8096:8096
      - 7359:7359/udp #Service Discovery
      - 1900:1900/udp #Client Discovery
    restart: unless-stopped

  jellyseerr:
    container_name: jellyseerr
    image: fallenbagel/jellyseerr:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Paris
    volumes:
      - ./jellyseerr:/app/config
    ports:
      - 5055:5055
    restart: unless-stopped
  gestionnaire-app:
    build: ./budget
    image: mon-gestionnaire-app
    restart: unless-stopped
    ports:
      - "2000:2000"
    volumes:
      - ./budget/data:/app/data
</file>

<file path="docker-compose/lxc-101-servarr/README.md">
# Stack de Services Média (*arrs, Jellyfin)

Ce dossier contient la configuration Docker Compose pour une stack média complète, automatisée et sécurisée.

## Services Inclus

*   `gluetun` : Client VPN qui crée un tunnel sécurisé pour le trafic sortant.
*   `qbittorrent` : Client BitTorrent.
*   `prowlarr` : Gestionnaire d'indexeurs.
*   `sonarr` : Gestionnaire de séries TV.
*   `radarr` : Gestionnaire de films.
*   `jellyfin` : Serveur média.
*   `jellyseerr` : Système de requêtes et de découverte de médias.
*   `gestionnaire-app` : Application web personnalisée construite à partir d'un Dockerfile local.

## Architecture Réseau

Cette stack utilise une architecture réseau spécifique pour la sécurité :

1.  **Isolation VPN** : `qbittorrent` et `prowlarr` sont configurés avec `network_mode: service:gluetun`. Tout leur trafic réseau passe **exclusivement** par le conteneur `gluetun`, garantissant qu'aucune donnée ne fuite si la connexion VPN tombe.
2.  **Réseau Interne** : Les autres services communiquent entre eux via un réseau Docker dédié (`servarrnetwork`), ce qui leur permet de se trouver facilement et de manière sécurisée.

## Configuration Requise (`.env`)

Ce déploiement est entièrement configurable via un fichier `.env`. Créez ce fichier à la racine de ce dossier avant de lancer les services.

**Exemple de fichier `.env` :**
```env
# .env.example
# Ce fichier est un exemple. Créez un fichier .env et remplissez-le avec vos propres valeurs.

# --- Configuration Générale ---
TZ=Europe/Paris
PUID=1000
PGID=1000

# --- Chemins d'accès aux Médias (spécifiques à votre serveur hôte) ---
MEDIA_ROOT=/media
DOWNLOADS_DIR=/media/data

# --- Secrets VPN (exemple pour ProtonVPN) ---
VPN_SERVICE_PROVIDER=protonvpn
VPN_TYPE=wireguard
WIREGUARD_PRIVATE_KEY=VOTRE_CLÉ_PRIVÉE_WIREGUARD

# --- Configuration VPN ---
VPN_PORT_FORWARDING=on
PORT_FORWARD_ONLY=on
SERVER_COUNTRIES=France
SERVER_CITIES=Marseille
```

## Déploiement

Une fois le fichier `.env` configuré :

```bash
docker-compose up -d
```

## Notes Spécifiques

*   **Application Personnalisée** : Le service `gestionnaire-app` est construit localement à partir du Dockerfile situé dans le dossier `budget/`.
*   **Sauvegarde** : Tous les dossiers de configuration (`./sonarr`, `./radarr`, etc.) sont ignorés par Git. Ils contiennent l'état des applications et doivent faire l'objet d'une **sauvegarde régulière**.````
</file>

<file path="docker-compose/lxc-102-reverse-proxy/.gitignore">
# .gitignore

# Ignorer les données de configuration et la base de données de NPM
data/

# Ignorer les certificats SSL
letsencrypt/

# Fichiers système
.DS_Store
</file>

<file path="docker-compose/lxc-102-reverse-proxy/README.md">
# Service Nginx Proxy Manager (Reverse Proxy)

Ce dossier contient la configuration pour déployer [Nginx Proxy Manager](https://nginxproxymanager.com/) via Docker Compose.

## Rôle

Ce service est le point d'entrée unique pour tout le trafic HTTP/S. Il agit comme un reverse proxy, gérant :
*   La terminaison des connexions SSL/TLS.
*   La génération et le renouvellement automatique des certificats Let's Encrypt.
*   Le routage des requêtes vers les services internes appropriés.

## Configuration Requise

Ce service ne nécessite aucune variable d'environnement dans un fichier `.env`. Toute la configuration se fait via l'interface web.

## Déploiement

```bash
docker-compose up -d
```

## Accès

*   **Interface d'administration** : `http://<IP_DU_LXC>:81`

## Sauvegarde (Important)

La configuration de ce service (hôtes, certificats) est stockée dans les volumes `data/` et `letsencrypt/`. Ces dossiers sont **ignorés par Git** et doivent faire l'objet d'une **sauvegarde régulière** pour pouvoir restaurer le service en cas de problème.
</file>

<file path="docker-compose/lxc-203-jenkins/Dockerfile">
# On part de l'image officielle de Jenkins
FROM jenkins/jenkins:lts-jdk17

# On passe en utilisateur root pour pouvoir installer des paquets
USER root

# On installe les dépendances et le client Docker
# C'est la même procédure que celle que nous avons faite dans le LXC
RUN apt-get update && apt-get install -y ca-certificates curl gnupg && \
    install -m 0755 -d /etc/apt/keyrings && \
    curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg && \
    chmod a+r /etc/apt/keyrings/docker.gpg && \
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
      $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
      tee /etc/apt/sources.list.d/docker.list > /dev/null && \
    apt-get update && \
    # On installe UNIQUEMENT le client, pas le serveur complet
    apt-get install -y docker-ce-cli

# On repasse à l'utilisateur jenkins, c'est une bonne pratique de sécurité
USER jenkins
</file>

<file path="scripts/backup_orchestrator.sh">
#!/bin/bash
set -e

# --- Configuration ---
# Mettez ici le user et les IPs/noms DNS de vos LXC
USER="clem"
LXC_ADGUARD="192.168.1.40"
LXC_NGINX="192.168.1.42"
LXC_SERVARR="localhost" # Le script tourne ici, donc on utilise localhost

# Dossier racine des projets DANS chaque LXC
PROJECTS_ROOT="/docker/servarr" # Adaptez si le chemin est différent dans les autres LXC

# Dossier de destination pour la sauvegarde FINALE sur ce LXC
BACKUP_DEST="/media/backup"

# Dossier de travail temporaire sur ce LXC pour rassembler les fichiers
TEMP_BACKUP_DIR="${BACKUP_DEST}/tmp"

# Nom du fichier de sauvegarde
DATE=$(date +"%Y-%m-%d")
BACKUP_FILENAME="homelab-backup-${DATE}.tar.gz"
BACKUP_FULL_PATH="${BACKUP_DEST}/${BACKUP_FILENAME}"

# --- Début du Script ---
echo "--- Lancement du script de sauvegarde orchestré ---"

# Créer les dossiers de travail s'ils n'existent pas
mkdir -p "${TEMP_BACKUP_DIR}"
mkdir -p "${BACKUP_DEST}"

# Fonction pour arrêter les services sur un LXC distant
stop_services() {
    echo "Arrêt des services sur $1..."
    ssh "${USER}@$1" "cd ${PROJECTS_ROOT}/$2 && docker-compose down"
}

# Fonction pour démarrer les services sur un LXC distant
start_services() {
    echo "Démarrage des services sur $1..."
    ssh "${USER}@$1" "cd ${PROJECTS_ROOT}/$2 && docker-compose up -d"
}

# 1. Arrêter TOUS les services pour garantir la cohérence des données
stop_services "$LXC_ADGUARD" "lxc-100-adguard"
stop_services "$LXC_NGINX" "lxc-101-nginx-proxy-manager"
stop_services "$LXC_SERVARR" "lxc-103-servarr-stack"

# 2. Copier toutes les données vers le dossier temporaire local via rsync
echo "Copie des données vers le nœud de gestion..."
# rsync -a: mode archive (préserve permissions, etc.), -z: compresse pendant le transfert
rsync -az "${USER}@${LXC_ADGUARD}:${PROJECTS_ROOT}/lxc-100-adguard/" "${TEMP_BACKUP_DIR}/lxc-100-adguard/"
rsync -az "${USER}@${LXC_NGINX}:${PROJECTS_ROOT}/lxc-101-nginx-proxy-manager/" "${TEMP_BACKUP_DIR}/lxc-101-nginx-proxy-manager/"
rsync -az "${PROJECTS_ROOT}/lxc-103-servarr-stack/" "${TEMP_BACKUP_DIR}/lxc-103-servarr-stack/" # Copie locale

# 3. Créer l'archive finale à partir du dossier temporaire
echo "Création de l'archive ${BACKUP_FILENAME}..."
# On se place dans le dossier temporaire pour que les chemins dans l'archive soient relatifs
tar -czf "${BACKUP_FULL_PATH}" -C "${TEMP_BACKUP_DIR}" .

# 4. Redémarrer TOUS les services (même si la sauvegarde a échoué, on veut que les services remontent)
# Utilisation d'un 'trap' pour garantir le redémarrage serait encore mieux, mais restons simples pour l'instant.
start_services "$LXC_ADGUARD" "lxc-100-adguard"
start_services "$LXC_NGINX" "lxc-101-nginx-proxy-manager"
start_services "$LXC_SERVARR" "lxc-103-servarr-stack"

# 5. Nettoyer le dossier temporaire
echo "Nettoyage du dossier temporaire..."
rm -rf "${TEMP_BACKUP_DIR}"

# 6. Nettoyer les anciennes sauvegardes
echo "Nettoyage des sauvegardes de plus de 7 jours..."
find "${BACKUP_DEST}" -name "homelab-backup-*.tar.gz" -mtime +7 -exec rm {} \;

echo "--- Script de sauvegarde terminé avec succès ---"
</file>

<file path="terraform/.terraform/providers/registry.terraform.io/hashicorp/local/2.6.1/linux_amd64/LICENSE.txt">
Copyright (c) 2017 HashiCorp, Inc.

Mozilla Public License Version 2.0
==================================

1. Definitions
--------------

1.1. "Contributor"
    means each individual or legal entity that creates, contributes to
    the creation of, or owns Covered Software.

1.2. "Contributor Version"
    means the combination of the Contributions of others (if any) used
    by a Contributor and that particular Contributor's Contribution.

1.3. "Contribution"
    means Covered Software of a particular Contributor.

1.4. "Covered Software"
    means Source Code Form to which the initial Contributor has attached
    the notice in Exhibit A, the Executable Form of such Source Code
    Form, and Modifications of such Source Code Form, in each case
    including portions thereof.

1.5. "Incompatible With Secondary Licenses"
    means

    (a) that the initial Contributor has attached the notice described
        in Exhibit B to the Covered Software; or

    (b) that the Covered Software was made available under the terms of
        version 1.1 or earlier of the License, but not also under the
        terms of a Secondary License.

1.6. "Executable Form"
    means any form of the work other than Source Code Form.

1.7. "Larger Work"
    means a work that combines Covered Software with other material, in
    a separate file or files, that is not Covered Software.

1.8. "License"
    means this document.

1.9. "Licensable"
    means having the right to grant, to the maximum extent possible,
    whether at the time of the initial grant or subsequently, any and
    all of the rights conveyed by this License.

1.10. "Modifications"
    means any of the following:

    (a) any file in Source Code Form that results from an addition to,
        deletion from, or modification of the contents of Covered
        Software; or

    (b) any new file in Source Code Form that contains any Covered
        Software.

1.11. "Patent Claims" of a Contributor
    means any patent claim(s), including without limitation, method,
    process, and apparatus claims, in any patent Licensable by such
    Contributor that would be infringed, but for the grant of the
    License, by the making, using, selling, offering for sale, having
    made, import, or transfer of either its Contributions or its
    Contributor Version.

1.12. "Secondary License"
    means either the GNU General Public License, Version 2.0, the GNU
    Lesser General Public License, Version 2.1, the GNU Affero General
    Public License, Version 3.0, or any later versions of those
    licenses.

1.13. "Source Code Form"
    means the form of the work preferred for making modifications.

1.14. "You" (or "Your")
    means an individual or a legal entity exercising rights under this
    License. For legal entities, "You" includes any entity that
    controls, is controlled by, or is under common control with You. For
    purposes of this definition, "control" means (a) the power, direct
    or indirect, to cause the direction or management of such entity,
    whether by contract or otherwise, or (b) ownership of more than
    fifty percent (50%) of the outstanding shares or beneficial
    ownership of such entity.

2. License Grants and Conditions
--------------------------------

2.1. Grants

Each Contributor hereby grants You a world-wide, royalty-free,
non-exclusive license:

(a) under intellectual property rights (other than patent or trademark)
    Licensable by such Contributor to use, reproduce, make available,
    modify, display, perform, distribute, and otherwise exploit its
    Contributions, either on an unmodified basis, with Modifications, or
    as part of a Larger Work; and

(b) under Patent Claims of such Contributor to make, use, sell, offer
    for sale, have made, import, and otherwise transfer either its
    Contributions or its Contributor Version.

2.2. Effective Date

The licenses granted in Section 2.1 with respect to any Contribution
become effective for each Contribution on the date the Contributor first
distributes such Contribution.

2.3. Limitations on Grant Scope

The licenses granted in this Section 2 are the only rights granted under
this License. No additional rights or licenses will be implied from the
distribution or licensing of Covered Software under this License.
Notwithstanding Section 2.1(b) above, no patent license is granted by a
Contributor:

(a) for any code that a Contributor has removed from Covered Software;
    or

(b) for infringements caused by: (i) Your and any other third party's
    modifications of Covered Software, or (ii) the combination of its
    Contributions with other software (except as part of its Contributor
    Version); or

(c) under Patent Claims infringed by Covered Software in the absence of
    its Contributions.

This License does not grant any rights in the trademarks, service marks,
or logos of any Contributor (except as may be necessary to comply with
the notice requirements in Section 3.4).

2.4. Subsequent Licenses

No Contributor makes additional grants as a result of Your choice to
distribute the Covered Software under a subsequent version of this
License (see Section 10.2) or under the terms of a Secondary License (if
permitted under the terms of Section 3.3).

2.5. Representation

Each Contributor represents that the Contributor believes its
Contributions are its original creation(s) or it has sufficient rights
to grant the rights to its Contributions conveyed by this License.

2.6. Fair Use

This License is not intended to limit any rights You have under
applicable copyright doctrines of fair use, fair dealing, or other
equivalents.

2.7. Conditions

Sections 3.1, 3.2, 3.3, and 3.4 are conditions of the licenses granted
in Section 2.1.

3. Responsibilities
-------------------

3.1. Distribution of Source Form

All distribution of Covered Software in Source Code Form, including any
Modifications that You create or to which You contribute, must be under
the terms of this License. You must inform recipients that the Source
Code Form of the Covered Software is governed by the terms of this
License, and how they can obtain a copy of this License. You may not
attempt to alter or restrict the recipients' rights in the Source Code
Form.

3.2. Distribution of Executable Form

If You distribute Covered Software in Executable Form then:

(a) such Covered Software must also be made available in Source Code
    Form, as described in Section 3.1, and You must inform recipients of
    the Executable Form how they can obtain a copy of such Source Code
    Form by reasonable means in a timely manner, at a charge no more
    than the cost of distribution to the recipient; and

(b) You may distribute such Executable Form under the terms of this
    License, or sublicense it under different terms, provided that the
    license for the Executable Form does not attempt to limit or alter
    the recipients' rights in the Source Code Form under this License.

3.3. Distribution of a Larger Work

You may create and distribute a Larger Work under terms of Your choice,
provided that You also comply with the requirements of this License for
the Covered Software. If the Larger Work is a combination of Covered
Software with a work governed by one or more Secondary Licenses, and the
Covered Software is not Incompatible With Secondary Licenses, this
License permits You to additionally distribute such Covered Software
under the terms of such Secondary License(s), so that the recipient of
the Larger Work may, at their option, further distribute the Covered
Software under the terms of either this License or such Secondary
License(s).

3.4. Notices

You may not remove or alter the substance of any license notices
(including copyright notices, patent notices, disclaimers of warranty,
or limitations of liability) contained within the Source Code Form of
the Covered Software, except that You may alter any license notices to
the extent required to remedy known factual inaccuracies.

3.5. Application of Additional Terms

You may choose to offer, and to charge a fee for, warranty, support,
indemnity or liability obligations to one or more recipients of Covered
Software. However, You may do so only on Your own behalf, and not on
behalf of any Contributor. You must make it absolutely clear that any
such warranty, support, indemnity, or liability obligation is offered by
You alone, and You hereby agree to indemnify every Contributor for any
liability incurred by such Contributor as a result of warranty, support,
indemnity or liability terms You offer. You may include additional
disclaimers of warranty and limitations of liability specific to any
jurisdiction.

4. Inability to Comply Due to Statute or Regulation
---------------------------------------------------

If it is impossible for You to comply with any of the terms of this
License with respect to some or all of the Covered Software due to
statute, judicial order, or regulation then You must: (a) comply with
the terms of this License to the maximum extent possible; and (b)
describe the limitations and the code they affect. Such description must
be placed in a text file included with all distributions of the Covered
Software under this License. Except to the extent prohibited by statute
or regulation, such description must be sufficiently detailed for a
recipient of ordinary skill to be able to understand it.

5. Termination
--------------

5.1. The rights granted under this License will terminate automatically
if You fail to comply with any of its terms. However, if You become
compliant, then the rights granted under this License from a particular
Contributor are reinstated (a) provisionally, unless and until such
Contributor explicitly and finally terminates Your grants, and (b) on an
ongoing basis, if such Contributor fails to notify You of the
non-compliance by some reasonable means prior to 60 days after You have
come back into compliance. Moreover, Your grants from a particular
Contributor are reinstated on an ongoing basis if such Contributor
notifies You of the non-compliance by some reasonable means, this is the
first time You have received notice of non-compliance with this License
from such Contributor, and You become compliant prior to 30 days after
Your receipt of the notice.

5.2. If You initiate litigation against any entity by asserting a patent
infringement claim (excluding declaratory judgment actions,
counter-claims, and cross-claims) alleging that a Contributor Version
directly or indirectly infringes any patent, then the rights granted to
You by any and all Contributors for the Covered Software under Section
2.1 of this License shall terminate.

5.3. In the event of termination under Sections 5.1 or 5.2 above, all
end user license agreements (excluding distributors and resellers) which
have been validly granted by You or Your distributors under this License
prior to termination shall survive termination.

************************************************************************
*                                                                      *
*  6. Disclaimer of Warranty                                           *
*  -------------------------                                           *
*                                                                      *
*  Covered Software is provided under this License on an "as is"       *
*  basis, without warranty of any kind, either expressed, implied, or  *
*  statutory, including, without limitation, warranties that the       *
*  Covered Software is free of defects, merchantable, fit for a        *
*  particular purpose or non-infringing. The entire risk as to the     *
*  quality and performance of the Covered Software is with You.        *
*  Should any Covered Software prove defective in any respect, You     *
*  (not any Contributor) assume the cost of any necessary servicing,   *
*  repair, or correction. This disclaimer of warranty constitutes an   *
*  essential part of this License. No use of any Covered Software is   *
*  authorized under this License except under this disclaimer.         *
*                                                                      *
************************************************************************

************************************************************************
*                                                                      *
*  7. Limitation of Liability                                          *
*  --------------------------                                          *
*                                                                      *
*  Under no circumstances and under no legal theory, whether tort      *
*  (including negligence), contract, or otherwise, shall any           *
*  Contributor, or anyone who distributes Covered Software as          *
*  permitted above, be liable to You for any direct, indirect,         *
*  special, incidental, or consequential damages of any character      *
*  including, without limitation, damages for lost profits, loss of    *
*  goodwill, work stoppage, computer failure or malfunction, or any    *
*  and all other commercial damages or losses, even if such party      *
*  shall have been informed of the possibility of such damages. This   *
*  limitation of liability shall not apply to liability for death or   *
*  personal injury resulting from such party's negligence to the       *
*  extent applicable law prohibits such limitation. Some               *
*  jurisdictions do not allow the exclusion or limitation of           *
*  incidental or consequential damages, so this exclusion and          *
*  limitation may not apply to You.                                    *
*                                                                      *
************************************************************************

8. Litigation
-------------

Any litigation relating to this License may be brought only in the
courts of a jurisdiction where the defendant maintains its principal
place of business and such litigation shall be governed by laws of that
jurisdiction, without reference to its conflict-of-law provisions.
Nothing in this Section shall prevent a party's ability to bring
cross-claims or counter-claims.

9. Miscellaneous
----------------

This License represents the complete agreement concerning the subject
matter hereof. If any provision of this License is held to be
unenforceable, such provision shall be reformed only to the extent
necessary to make it enforceable. Any law or regulation which provides
that the language of a contract shall be construed against the drafter
shall not be used to construe this License against a Contributor.

10. Versions of the License
---------------------------

10.1. New Versions

Mozilla Foundation is the license steward. Except as provided in Section
10.3, no one other than the license steward has the right to modify or
publish new versions of this License. Each version will be given a
distinguishing version number.

10.2. Effect of New Versions

You may distribute the Covered Software under the terms of the version
of the License under which You originally received the Covered Software,
or under the terms of any subsequent version published by the license
steward.

10.3. Modified Versions

If you create software not governed by this License, and you want to
create a new license for such software, you may create and use a
modified version of this License if you rename the license and remove
any references to the name of the license steward (except to note that
such modified license differs from this License).

10.4. Distributing Source Code Form that is Incompatible With Secondary
Licenses

If You choose to distribute Source Code Form that is Incompatible With
Secondary Licenses under the terms of this version of the License, the
notice described in Exhibit B of this License must be attached.

Exhibit A - Source Code Form License Notice
-------------------------------------------

  This Source Code Form is subject to the terms of the Mozilla Public
  License, v. 2.0. If a copy of the MPL was not distributed with this
  file, You can obtain one at http://mozilla.org/MPL/2.0/.

If it is not possible or desirable to put the notice in a particular
file, then You may include the notice in a location (such as a LICENSE
file in a relevant directory) where a recipient would be likely to look
for such a notice.

You may add additional accurate notices of copyright ownership.

Exhibit B - "Incompatible With Secondary Licenses" Notice
---------------------------------------------------------

  This Source Code Form is "Incompatible With Secondary Licenses", as
  defined by the Mozilla Public License, v. 2.0.
</file>

<file path="terraform/.terraform/providers/registry.terraform.io/telmate/proxmox/3.0.2-rc04/linux_amd64/LICENSE">
The MIT License (MIT)

Copyright (c) 2017 <copyright holders>

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
</file>

<file path="terraform/.terraform/providers/registry.terraform.io/telmate/proxmox/3.0.2-rc04/linux_amd64/README.md">
[![Build Status](https://travis-ci.com/Telmate/terraform-provider-proxmox.svg?branch=master)](https://travis-ci.com/Telmate/terraform-provider-proxmox)

# Terraform provider plugin for Proxmox

This repository provides a Terraform provider for
the [Proxmox virtualization platform](https://pve.proxmox.com/pve-docs/) and exposes Terraform resources to provision
QEMU VMs and LXC Containers.

## Getting Started

In order to get started, use [the documentation included in this repository](docs/index.md). The documentation contains
a list of the options for the provider. Moreover, there are some guides available how to combine options and start
specific VMs.

## Quick Start

Follow this [install guide](docs/guides/installation.md) to install the plugin.

## Known Limitations

* `proxmox_vm_qemu`.`disk`.`size` attribute does not match what is displayed in the Proxmox UI.
* Updates to `proxmox_vm_qemu` resources almost always result as a failed task within the Proxmox UI. This appears to be
  harmless and the desired configuration changes do get applied.
* When using the `proxmox_lxc` resource, the provider will crash unless `rootfs` is defined.
* When using the Network Boot mode (PXE), a valid NIC must be defined for the VM, and the boot order must specify network first.

## Contributing

When contributing, please also add documentation to help other users.

### Debugging the provider

Debugging is available for this provider through the Terraform Plugin SDK versions 2.0.0. Therefore, the plugin can be
started with the debugging flag `--debug`.

For example (using [delve](https://github.com/go-delve/delve) as Debugger):

```bash
dlv exec --headless ./terraform-provider-my-provider -- --debug
```

For more information about debugging a provider please
see: [Debugger-Based Debugging](https://www.terraform.io/docs/extend/debugging.html#debugger-based-debugging)

## Useful links

* [Proxmox](https://www.proxmox.com/en/)
* [Proxmox documentation](https://pve.proxmox.com/pve-docs/)
* [Terraform](https://www.terraform.io/)
* [Terraform documentation](https://www.terraform.io/docs/index.html)
* [Recommended ISO builder](https://github.com/Telmate/terraform-ubuntu-proxmox-iso)
</file>

<file path="terraform/.gitignore">
terraform.tfvars
.terraform.lock.hcl
terraform.tfstate
</file>

<file path="terraform/variables.tf">
variable "proxmox_api_url" {
  type        = string
  description = "The URL for the Proxmox API (e.g., https://192.168.1.100:8006/api2/json)"
}

variable "proxmox_api_token_id" {
  type        = string
  description = "The Proxmox API token ID."
  sensitive   = true
}

variable "proxmox_api_token_secret" {
  type        = string
  description = "The Proxmox API token secret."
  sensitive   = true
}

variable "proxmox_node" {
  type        = string
  description = "The Proxmox node to create the LXC on."
  default     = "pve"
}

variable "lxc_template" {
  type        = string
  description = "The LXC template to use (e.g., local:vztmpl/debian-11-standard_11.3-1_amd64.tar.gz)."
}

variable "root_password" {
  type        = string
  description = "The root password for the LXC container console."
  sensitive   = true
}

variable "ssh_public_key" {
  type        = string
  description = "The SSH public key to install on the containers for Ansible access."
  sensitive   = true
}
</file>

<file path=".gitignore">
ansible/credentials.yml
</file>

<file path="Jenkinsfile">
// Déclaration du pipeline
pipeline {
    // L'agent spécifie où le pipeline va s'exécuter. 'any' signifie sur n'importe quel agent disponible.
    agent any

    // Les 'stages' sont les étapes de notre pipeline
    stages {
        // Étape 1: Valider le code Terraform
        stage('Terraform Validate') {
            steps {
                // Le 'dir' change le répertoire de travail pour les commandes suivantes
                dir('terraform') {
                    sh 'terraform init'
                    sh 'terraform validate'
                }
            }
        }

        // Étape 2: Planifier les changements Terraform
        stage('Terraform Plan') {
            steps {
                dir('terraform') {
                    // NOTE: La gestion des secrets (variables.tfvars) est un sujet avancé.
                    // Pour commencer, on peut supposer que le fichier est déjà sur le serveur Jenkins.
                    sh 'terraform plan'
                }
            }
        }

        // Étape 3: Appliquer les changements (étape manuelle pour la sécurité)
        stage('Terraform Apply') {
            steps {
                // 'input' met le pipeline en pause et attend une confirmation manuelle
                input 'Do you want to apply the Terraform changes?'
                dir('terraform') {
                    sh 'terraform apply -auto-approve'
                }
            }
        }

        // Étape 4: Lancer la configuration Ansible
        stage('Ansible Provision') {
            steps {
                input 'Do you want to run the Ansible playbook?'
                dir('ansible') {
                    // La gestion du mot de passe du vault est complexe.
                    // On peut le stocker dans les "Credentials" de Jenkins.
                    // Pour commencer, on peut le passer via une variable d'environnement (moins sécurisé).
                    sh 'ansible-playbook site.yml'
                }
            }
        }
    }
}
</file>

<file path="ansible/provisioning/adguard.yml">
---
- name: Deploy AdGuard Home
  hosts: adguard
  gather_facts: no
  tasks:
    - name: Start the AdGuard stack with Docker Compose
      community.docker.docker_compose_v2:
        project_src: '/opt/homelab-stack/docker-compose/lxc-100-adguard'
        state: present
</file>

<file path="ansible/provisioning/servarr.yml">
---
- name: Deploy Servarr Stack  
  hosts: servarr
  gather_facts: no             
  become: true               

  tasks:                    
    - name: Start the Servarr stack with Docker Compose
      community.docker.docker_compose_v2:
        project_src: '/opt/homelab-stack/docker-compose/lxc-101-servarr'
        state: present
        remove_orphans: yes
</file>

<file path="ansible/roles/common/handlers/main.yml">
---
- name: Restart containerd
  ansible.builtin.service:
    name: containerd
    state: restarted

- name: Restart docker
  ansible.builtin.service:
    name: docker
    state: restarted
</file>

<file path="ansible/roles/users/tasks/main.yml">
---
# tasks file for roles/users
- name: Ensure the sudo group is present
  ansible.builtin.group:
    name: sudo
    state: present

- name: Create the 'clem' user
  ansible.builtin.user:
    name: clem
    comment: "Clem Administrator Account"
    shell: /bin/bash
    groups: sudo  # Add the user to the sudo group
    append: yes   # Ensure we ADD the group, not replace others
    create_home: yes
    state: present
    # This securely sets the password by hashing the variable from our vault
    password: "{{ user_clem_password | password_hash('sha512') }}"

- name: Allow 'clem' to run sudo without a password
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    state: present
    regexp: '^%sudo'
    line: '%sudo ALL=(ALL) NOPASSWD: ALL'
    # This is a CRITICAL safety check to prevent locking yourself out.
    validate: 'visudo -cf %s'

- name: Ensure fish shell is installed
  ansible.builtin.package:
    name: fish
    state: present

- name: Find the path to the fish executable
  ansible.builtin.command: which fish
  register: fish_path_result
  changed_when: false # This command doesn't change anything, just gathers info
  check_mode: false  # Always run this command even in check mode

- name: Set fish as the default shell for the 'root' user
  ansible.builtin.user:
    name: root
    shell: "{{ fish_path_result.stdout }}"

# -----------------------------------------------------------------
# TASK SET 2: Set default starting directory for root's fish shell
# -----------------------------------------------------------------

- name: Ensure the default start directory exists
  ansible.builtin.file:
    path: "{{ default_start_dir }}"
    state: directory
    mode: '0755'

- name: Configure default directory for root's fish shell
  ansible.builtin.blockinfile:
    path: /root/.config/fish/config.fish
    create: yes # Creates the file and directories if they don't exist
    owner: root
    group: root
    mode: '0644'
    block: |
      # Set default directory on interactive shell start (managed by Ansible)
      if status is-interactive
        cd {{ default_start_dir }}
      end
</file>

<file path="ansible/ansible.cfg">
[defaults]
inventory      = inventory.tf.ini
roles_path     = ./roles
host_key_checking = False

stdout_callback = default
display_ok_hosts = yes
display_skipped_hosts = yes
result_format = yaml

[privilege_escalation]
become = True
</file>

<file path="docker-compose/lxc-102-reverse-proxy/docker-compose.yml">
services:
  app:
    image: 'jc21/nginx-proxy-manager:latest'
    container_name: nginx-proxy-manager
    restart: unless-stopped
    ports:
      - '80:80'
      - '443:443'
      - '81:81'
    volumes:
      - ./data:/data
      - /media/docker-data/nginx:/config
      - ./letsencrypt:/etc/letsencrypt
</file>

<file path="docker-compose/lxc-203-jenkins/docker-compose.yml">
version: '3.8'

services:
  jenkins:
    build: .
    container_name: jenkins
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - /media/docker-data/jenkins:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=Europe/Paris  

volumes:
  jenkins_home:
    name: jenkins_home
</file>

<file path="README.md">
# Mon Infrastructure Homelab as Code

Ce dépôt contient l'intégralité de la configuration de mon infrastructure personnelle (Homelab). Le but de ce projet est de gérer 100% de l'infrastructure en suivant les principes de l'**Infrastructure as Code (IaC)**.

La philosophie est simple : aucune configuration manuelle n'est autorisée sur les serveurs. Toute modification doit être effectuée via ce dépôt Git, garantissant une infrastructure **reproductible**, **documentée** et **sécurisée**.

## Architecture Générale

L'infrastructure repose sur un hyperviseur Proxmox qui héberge plusieurs conteneurs LXC, chacun avec un rôle défini :

*   **LXC 100 (`lxc-100-adguard`)** : Serveur DNS. Gère le filtrage des publicités et les résolutions DNS locales pour l'ensemble du réseau.
*   **LXC 101 (`lxc-101-servarr`)** : Cœur applicatif. Héberge la stack de services média (*arrs, Jellyfin) ainsi que des applications personnalisées. Une partie de ses services est routée à travers un tunnel VPN pour la confidentialité.
*   **LXC 103 (`lxc-102-reverse-proxy`)** : Reverse Proxy. C'est le point d'entrée unique pour tous les services HTTP/S. Il gère la terminaison SSL et le routage des requêtes vers les bons services.

## Structure du Dépôt

Chaque dossier à la racine de ce dépôt correspond à un LXC et contient la définition de ses services via `docker-compose`.

*   `lxc-100-adguard/` : Définition du service AdGuard Home.
*   `lxc-101-servarr` : Définition de la stack média complète, incluant le client VPN et une application custom.
*   `lxc-102-reverse-proxy` : Définition du service Nginx Proxy Manager.

## Déploiement

Chaque service est autonome. Pour déployer un LXC :

1.  Se connecter en SSH au LXC cible.
2.  Cloner ce dépôt : `git clone <URL_DU_DÉPÔT> .`
3.  Naviguer dans le dossier correspondant (ex: `cd lxc-100-adguard`).
4.  Créer un fichier `.env` en se basant sur les instructions du `README.md` du sous-dossier. **Ce fichier contient les secrets et n'est pas versionné dans Git.**
5.  Lancer les services : `docker-compose up -d`.

## Principes Clés Mis en Œuvre

*   **Infrastructure as Code** : Tout est décrit dans des fichiers YAML et géré par Git.
*   **Gestion des Secrets** : Séparation stricte de la configuration (commitée) et des secrets (via des fichiers `.env` ignorés).
*   **Isolation** : Chaque service tourne dans son propre conteneur Docker, et chaque groupe de services est isolé dans son LXC.
*   **Reproductibilité** : Capacité de reconstruire n'importe quel service ou l'infrastructure entière à partir de ce dépôt et d'une sauvegarde des données.

## Prochaines Étapes

- [ ] **Automatisation du déploiement** avec Ansible pour provisionner les LXC de manière 100% automatique.
- [ ] **Migration vers Kubernetes (k3s)** pour une orchestration avancée.
- [ ] **Mise en place de GitOps** avec ArgoCD pour des déploiements continus basés sur les commits Git.
</file>

<file path="ansible/group_vars/all/vault.yml">
$ANSIBLE_VAULT;1.1;AES256
38393065653164393232313137613034653464646133306639613139663262383665643263363365
6432646439383435373234313733656265613065373330630a393035633634633532616636356334
37386362623133353436323734626164373731343939633332356133393730333765333661303263
6162666533643962350a626135326439303838353031313835656139636438633632396363393961
65343135373334376232393230383266386535383836313437383133656639636537
</file>

<file path="ansible/roles/common/tasks/docker.yml">
---
 
- name: Docker | Install prerequisite packages
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - ca-certificates
      - gnupg
    state: present

- name: Docker | Add Docker GPG key
  ansible.builtin.get_url:
    url: https://download.docker.com/linux/debian/gpg
    dest: /etc/apt/keyrings/docker.asc
    mode: '0644'
    force: true

- name: Docker | Add Docker repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
    state: present
    filename: docker

- name: Docker | Install Docker packages
  ansible.builtin.apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present
    update_cache: yes

- name: Docker | Ensure Docker service is running and enabled
  ansible.builtin.service:
    name: docker
    state: started
    enabled: yes

- name: "Check all available versions of containerd.io"
  ansible.builtin.shell:
    cmd: "apt-cache madison containerd.io"
  register: containerd_versions_raw
  changed_when: false

- name: "Parse and find the latest valid containerd.io version"
  block:
    - name: "Create a list of valid, installable versions"
      ansible.builtin.set_fact:
        good_versions: >
          {{
            containerd_versions_raw.stdout_lines
            | select('contains', 'containerd.io |')
            | map('split', '|')
            | map(attribute=1)
            | map('trim')
            | select('version', problematic_version_start, '<')
            | list
          }}

    - name: "Select the target version to install"
      ansible.builtin.set_fact:
        target_containerd_version: "{{ good_versions[0] }}"

  rescue:
    - name: "Fail gracefully if no suitable older version was found"
      ansible.builtin.fail:
        msg: >
          "FATAL: Could not find any version of 'containerd.io' older than the problematic
          version '{{ problematic_version_start }}' in the apt repositories.
          The automation cannot proceed. Please investigate the available packages on this host."

- name: "Install the automatically selected version: {{ target_containerd_version }}"
  ansible.builtin.apt:
    name: "containerd.io={{ target_containerd_version }}"
    state: present
    allow_downgrade: yes
  notify:
    - Restart containerd
    - Restart docker

- name: "Hold containerd.io package at the selected version"
  ansible.builtin.dpkg_selections:
    name: containerd.io
    selection: hold

- name: Clone the docker-compose repository
  ansible.builtin.git:
    repo: 'https://github.com/clementtrecourt/homelab-stack.git'
    dest: '/opt/homelab-stack'
    version: 'master'
    update: yes
    force: yes
</file>

<file path="ansible/inventory.tf.ini">
# This file is automatically generated by Terraform.
# Do not edit manually!

[lxc_hosts]
adguard ansible_host=192.168.1.30
jenkins ansible_host=192.168.1.33
nginx ansible_host=192.168.1.32
servarr ansible_host=192.168.1.31
[proxmox_host]
pve ansible_host=192.168.1.50
[proxmox_host:vars]
ansible_user=root
servarr_vmid=201 
[all:vars]
ansible_user=root
ansible_password=clement2509
ansible_ssh_common_args='-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
</file>

<file path="terraform/inventory.tpl">
# This file is automatically generated by Terraform.
# Do not edit manually!

[lxc_hosts]
%{ for name, container in containers ~}
${name} ansible_host=${container.ip}
%{ endfor ~}
[proxmox_host]
pve ansible_host=192.168.1.50
[proxmox_host:vars]
ansible_user=root
servarr_vmid=201 
[all:vars]
ansible_user=root
ansible_password=${root_password}
ansible_ssh_common_args='-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
</file>

<file path="docker-compose/lxc-101-servarr/docker-compose.yml">
# All config volumes now point to /media/docker-data/

networks:
  servarrnetwork:
    name: servarrnetwork
    ipam:
      config:
        - subnet: 172.39.0.0/24

services:
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - WEBUI_PORT=8080
    volumes:
      - /media/docker-data/qbittorrent:/config
      - /media/library:/data
    ports:
      - "8080:8080"
      - "6881:6881"
      - "6881:6881/udp"
    networks:
      servarrnetwork:
        ipv4_address: 172.39.0.5

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - /media/docker-data/prowlarr:/config
    ports:
      - "9696:9696"
    networks:
      servarrnetwork:
        ipv4_address: 172.39.0.6

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - /media/docker-data/sonarr:/config
      - /media:/media
    ports:
      - "8989:8989"
    networks:
      servarrnetwork:
        ipv4_address: 172.39.0.3

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - /media/docker-data/radarr:/config
      - /media:/media
    ports:
      - "7878:7878"
    networks:
      servarrnetwork:
        ipv4_address: 172.39.0.4

  jellyfin:
    image: lscr.io/linuxserver/jellyfin:latest
    container_name: jellyfin
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Paris
    volumes:
      - /media/docker-data/jellyfin:/config
      - /media:/media
    devices:
      - /dev/dri:/dev/dri #Use for Intel QuickSync
    ports:
      - "8096:8096"
      - "7359:7359/udp"
      - "1900:1900/udp"
    restart: unless-stopped

  jellyseerr:
    container_name: jellyseerr
    image: fallenbagel/jellyseerr:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Paris
    volumes:
      - /media/docker-data/jellyseerr:/app/config
    ports:
      - "5055:5055"
    restart: unless-stopped

  gestionnaire-app:
    build: ./budget
    image: mon-gestionnaire-app
    restart: unless-stopped
    ports:
      - "2000:2000"
    volumes:
      - /media/docker-data/budget/data:/app/data
</file>

<file path="ansible/roles/common/tasks/main.yml">
---
# tasks file for roles/common
- name: Update apt cache and upgrade all packages
  ansible.builtin.apt:
    update_cache: yes
    upgrade: dist
    cache_valid_time: 3600

- name: Install common base packages
  ansible.builtin.apt:
    name:
      - curl
      - git
      - ufw
      - sudo
      - btop
      - fastfetch
      - python3-docker
      - fish
    state: present

- name: Install and configure Docker
  ansible.builtin.include_tasks: docker.yml
  vars:
    problematic_version_start: "1.7.28-2"

- name: Add 'dk' alias for user 'root'
  become: true # Become root to be able to write to clem's home directory
  ansible.builtin.lineinfile:
    path: /home/root/.bashrc
    line: "alias dk='cd /opt/homelab-stack/docker-compose'"
    create: yes
</file>

<file path="docker-compose/lxc-100-adguard/docker-compose.yml">
services:
  adguardhome:
    image: adguard/adguardhome:latest
    container_name: adguardhome
    environment:
      - ADGUARD_PASSWORD_HASH=${ADGUARD_PASSWORD_HASH}
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "3000:3000/tcp"
    volumes:
      - /media/docker-data/adguard/work:/opt/adguardhome/work
      - /media/docker-data/adguard/conf:/opt/adguardhome/conf
    restart: unless-stopped
</file>

<file path="terraform/main.tf">
terraform {
  required_providers {
    proxmox = {
      source  = "telmate/proxmox"
      version = "3.0.2-rc04"
    }
  }
}

provider "proxmox" {
  pm_api_url          = var.proxmox_api_url
  pm_api_token_id     = var.proxmox_api_token_id
  pm_api_token_secret = var.proxmox_api_token_secret
  pm_tls_insecure     = true
  pm_debug            = true
}
# resource "proxmox_virtual_environment_network_linux_bridge" "subnet_bridge" {
#   node_name = var.proxmox_node
#   name      = "vmbr1"
#   comment   = "Sous-réseau interne pour les conteneurs Terraform (10.20.30.0/24)"
  
#   address   = "10.20.30.1/24" 
  
# }
locals {
  containers = {
    adguard = {
      vmid = 200
      ip   = "192.168.1.30/24" # Nouvelle IP
      cores = 1
      memory = 512
      swap = 1024
      rootfs_size = "8G" 
    }
    servarr = {
      vmid = 201
      ip   = "192.168.1.31/24" # Nouvelle IP
      cores = 3             
      memory = 2861
      swap = 1024
      rootfs_size = "32G"         
    }
    nginx = {
      vmid = 202
      ip   = "192.168.1.32/24" # Nouvelle IP
      cores = 1
      memory = 512
      swap = 1024
      rootfs_size = "8G" 
    }
      jenkins = {
      vmid   = 203 
      ip     = "192.168.1.33/24"
      cores  = 2     
      memory = 2048  
      swap   = 2048
      rootfs_size = "8G" 
    }
  }
}


resource "proxmox_lxc" "ct_group" {
  # depends_on = [proxmox_virtual_environment_network_linux_bridge.subnet_bridge]
  for_each = local.containers

  target_node  = var.proxmox_node
  ostemplate   = var.lxc_template
  # password     = var.root_password
  unprivileged = true
  start        = true
  
  rootfs {
    storage = "local-lvm"
    size    = each.value.rootfs_size
  }
  password = var.root_password
  ssh_public_keys = var.ssh_public_key
  nameserver   = "1.1.1.1" # Or your preferred DNS
  searchdomain = "local"
  network {
    name   = "eth0"
    bridge = "vmbr0"             # On utilise le nouveau pont
    gw     = "192.168.1.254"        # La passerelle est l'IP du pont vmbr1
    ip     = each.value.ip
    ip6    = "auto"
  }
  features {
    nesting = true
  }
  # --- Values that are unique for each container ---
  # 'each.key' is the name (e.g., "adguard", "servarr")
  # 'each.value' is the map of attributes for that name
  
  vmid     = each.value.vmid
  hostname = each.key
  tags     = each.key
  cores    = each.value.cores
  memory   = each.value.memory
  swap     = each.value.swap
}

# 3. The output is now much cleaner and automatically updates
#    if you add/remove containers from the locals map.
output "container_details" {
  description = "A map of container details including their IP addresses."
  value = {
    for name, container in proxmox_lxc.ct_group : name => {
      ip = trimsuffix(container.network[0].ip, "/24") # Removes the /24 part for Ansible
    }
  }
  sensitive = true # Mark as sensitive if it contains IPs you want to hide in logs
}

# This resource creates the Ansible inventory file dynamically.
resource "local_file" "ansible_inventory" {
  # The content is generated from the template file and our Terraform data.
  content = templatefile("${path.module}/inventory.tpl", {
    # The 'containers' variable in the template will be populated by this map.
    containers = {
      for name, container in proxmox_lxc.ct_group : name => {
        ip = trimsuffix(container.network[0].ip, "/24")
      }
    },
    # Pass the root password to the template for the ansible_password var.
    root_password = var.root_password
  })
  
  filename = "${path.module}/../ansible/inventory.tf.ini"
}
</file>

<file path="terraform/terraform.tfstate.backup">
{
  "version": 4,
  "terraform_version": "1.13.5",
  "serial": 137,
  "lineage": "d2373174-bdc4-5cfa-d41d-3cb924e6b4d2",
  "outputs": {},
  "resources": [],
  "check_results": null
}
</file>

<file path="ansible/group_vars/all.yml">
$ANSIBLE_VAULT;1.1;AES256
38653935333834303163333433313763653634633334376363653830333639663561633738656564
6662616361656265663563346537393530353334373932360a646530313430663631323463353830
32353563393965623834666130333030303761373366396334366464313533376338396136306236
3838623262346362300a393265343837373339303665626636316235313037303234343561353734
64346164396333643932383236353666616537643264663232653134303165306564663832613266
32303132363366316436653739393366343530626362653535313861343834323430333561343435
66363062306434646535616634343133363661626630383563333533396636396238623634346663
30663934653466303734633438613337323937626530303966616431633131373232366235393134
37656235623731613231393865376433643031656332303834393836373730343633336434623662
65656237663963393932383237376236323866313733313431663030333163313763303834663865
33386466663336386233353063383532623430396639663035633936336536656134633465313166
61623236336535323836353736643838303639666331666365313031656163643835313039386638
3439
</file>

<file path="ansible/provisioning/configure_proxmox.yml">
# ======================================================================
# Play : Gérer la configuration des conteneurs sur l'hôte Proxmox
# ======================================================================
- name: Configure LXC Settings on Proxmox Host
  hosts: proxmox_host
  become: true
  
  vars_files:
    - ../group_vars/all.yml
  
  vars:
    # UID/GID de l'utilisateur DANS les conteneurs LXC
    lxc_user_uid: 1000
    lxc_user_gid: 1000

    # Calcul de l'UID/GID mappé sur l'hôte PVE (par défaut, Proxmox ajoute 100000)
    host_mapped_uid: "{{ 100000 | int + lxc_user_uid | int }}"
    host_mapped_gid: "{{ 100000 | int + lxc_user_gid | int }}"

    # Chemin source sur l'hôte PVE
    docker_data_source_path: "/media"
    
  tasks:
    # ------------------------------------------------------------------
    # Tâche 1 : Préparer le dossier sur l'hôte PVE avec les permissions mappées
    # ------------------------------------------------------------------
    - name: "Ensure the Docker data directory exists on the PVE host"
      ansible.builtin.file:
        path: "{{ docker_data_source_path }}"
        state: directory
        mode: '0755'

    - name: "Ensure ownership is set to the MAPPED UID/GID on the PVE host"
      ansible.builtin.file:
        path: "{{ docker_data_source_path }}/"
        owner: "{{ host_mapped_uid }}"   # <-- CORRECTION CRUCIALE
        group: "{{ host_mapped_gid }}"   # <-- CORRECTION CRUCIALE
        recurse: yes
        
    # ------------------------------------------------------------------
    # Tâche 2 : Configurer le point de montage dans les fichiers .conf des LXC
    # ------------------------------------------------------------------
    - name: "Ensure /media/docker-data is mounted in all LXCs"
      ansible.builtin.lineinfile:
        path: "/etc/pve/lxc/{{ vmid[item] }}.conf"
        line: "mp0: {{ docker_data_source_path }},mp={{ docker_data_source_path }}"
        regexp: "^mp0:"  # Assure qu'il n'y a qu'une seule ligne mp0
        state: present
      loop: "{{ groups['lxc_hosts'] }}"
      notify: Restart changed LXC # On notifie un handler pour le redémarrage
      register: mount_results

    # ------------------------------------------------------------------
    # Tâche 3 : Configurer le passthrough GPU/TUN pour servarr (plus robuste)
    # ------------------------------------------------------------------
    - name: "Ensure device passthrough is configured for the servarr LXC"
      ansible.builtin.blockinfile:
        path: "/etc/pve/lxc/{{ vmid.servarr }}.conf"
        state: present
        create: yes  # Crée le fichier s'il n'existe pas (bonne pratique)
        # Le marqueur permet à Ansible de retrouver et gérer ce bloc spécifique
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Servarr Passthrough"
        block: |
          lxc.cgroup2.devices.allow: c 226:0 rwm
          lxc.cgroup2.devices.allow: c 226:128 rwm
          lxc.mount.entry: /dev/dri dev/dri none bind,optional,create=dir
          lxc.cgroup2.devices.allow: c 10:200 rwm
          lxc.mount.entry: /dev/net/tun dev/net/tun none bind,create=file
      notify: Restart servarr LXC
      register: passthrough_result

  # ------------------------------------------------------------------
  # Handlers : Gèrent les redémarrages à la fin du play, seulement si nécessaire
  # ------------------------------------------------------------------
  handlers:
    - name: Restart changed LXC
      ansible.builtin.command:
        cmd: "pct reboot {{ vmid[item.item] }}"
      loop: "{{ mount_results.results }}"
      when: item.changed and item.item != 'servarr' # On ne redémarre pas servarr deux fois
      loop_control:
        label: "Restarting {{ item.item }} due to mount change"
      listen: Restart changed LXC

    - name: Restart servarr LXC
      ansible.builtin.command:
        cmd: "pct reboot {{ vmid.servarr }}"
      listen: Restart servarr LXC
</file>

<file path="ansible/site.yml">
---
- name: 1. Apply common configuration to all LXC hosts
  hosts: lxc_hosts
  roles:
    - role: common
    - role: users
          
    
    
- name: 2. Prepare Proxmox
  import_playbook: provisioning/configure_proxmox.yml  
- name: 3. Deploy AdGuard Home
  import_playbook: provisioning/adguard.yml 

- name: 4. Deploy Nginx
  import_playbook: provisioning/nginx.yml

- name: 5. Deploy Servarr
  import_playbook: provisioning/servarr.yml
</file>

</files>
