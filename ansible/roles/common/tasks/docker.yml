---
 
- name: Docker | Install prerequisite packages
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - ca-certificates
      - gnupg
    state: present

- name: Docker | Add Docker GPG key
  ansible.builtin.get_url:
    url: https://download.docker.com/linux/debian/gpg
    dest: /etc/apt/keyrings/docker.asc
    mode: '0644'
    force: true

- name: Docker | Add Docker repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
    state: present
    filename: docker

- name: Docker | Install Docker packages
  ansible.builtin.apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present
    update_cache: yes

- name: Docker | Ensure Docker service is running and enabled
  ansible.builtin.service:
    name: docker
    state: started
    enabled: yes

- name: "Check all available versions of containerd.io"
  ansible.builtin.shell:
    cmd: "apt-cache madison containerd.io"
  register: containerd_versions_raw
  changed_when: false

- name: "Parse and find the latest valid containerd.io version"
  block:
    - name: "Create a list of valid, installable versions"
      ansible.builtin.set_fact:
        good_versions: >
          {{
            containerd_versions_raw.stdout_lines
            | select('contains', 'containerd.io |')
            | map('split', '|')
            | map(attribute=1)
            | map('trim')
            | select('version', problematic_version_start, '<')
            | list
          }}

    - name: "Select the target version to install"
      ansible.builtin.set_fact:
        target_containerd_version: "{{ good_versions[0] }}"

  rescue:
    - name: "Fail gracefully if no suitable older version was found"
      ansible.builtin.fail:
        msg: >
          "FATAL: Could not find any version of 'containerd.io' older than the problematic
          version '{{ problematic_version_start }}' in the apt repositories.
          The automation cannot proceed. Please investigate the available packages on this host."

- name: "Install the automatically selected version: {{ target_containerd_version }}"
  ansible.builtin.apt:
    name: "containerd.io={{ target_containerd_version }}"
    state: present
    allow_downgrade: yes
  notify:
    - Restart containerd
    - Restart docker

- name: "Hold containerd.io package at the selected version"
  ansible.builtin.dpkg_selections:
    name: containerd.io
    selection: hold

- name: Clone the docker-compose repository
  ansible.builtin.git:
    repo: 'https://github.com/clementtrecourt/homelab-stack.git'
    dest: '/opt/homelab-stack'
    version: 'master'
    update: yes
    force: yes

