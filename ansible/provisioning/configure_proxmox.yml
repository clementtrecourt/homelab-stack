# ======================================================================
# Play : Gérer la configuration des conteneurs sur l'hôte Proxmox
# ======================================================================
- name: Configure LXC Settings on Proxmox Host
  hosts: proxmox_host
  become: true
  
  vars_files:
    - ../group_vars/all.yml
  
  vars:
    # UID/GID de l'utilisateur DANS les conteneurs LXC
    lxc_user_uid: 1000
    lxc_user_gid: 1000

    # Calcul de l'UID/GID mappé sur l'hôte PVE (par défaut, Proxmox ajoute 100000)
    host_mapped_uid: "{{ 100000 | int + lxc_user_uid | int }}"
    host_mapped_gid: "{{ 100000 | int + lxc_user_gid | int }}"

    # Chemin source sur l'hôte PVE
    docker_data_source_path: "/media"
    
  tasks:
    # ------------------------------------------------------------------
    # Tâche 1 : Préparer le dossier sur l'hôte PVE avec les permissions mappées
    # ------------------------------------------------------------------
    - name: "Ensure the Docker data directory exists on the PVE host"
      ansible.builtin.file:
        path: "{{ docker_data_source_path }}"
        state: directory
        mode: '0755'

    - name: "Ensure ownership is set to the MAPPED UID/GID on the PVE host"
      ansible.builtin.file:
        path: "{{ docker_data_source_path }}/"
        owner: "{{ host_mapped_uid }}"   # <-- CORRECTION CRUCIALE
        group: "{{ host_mapped_gid }}"   # <-- CORRECTION CRUCIALE
        recurse: yes
        
    # ------------------------------------------------------------------
    # Tâche 2 : Configurer le point de montage dans les fichiers .conf des LXC
    # ------------------------------------------------------------------
    - name: "Ensure /media/docker-data is mounted in all LXCs"
      ansible.builtin.lineinfile:
        path: "/etc/pve/lxc/{{ vmid[item] }}.conf"
        line: "mp0: {{ docker_data_source_path }},mp={{ docker_data_source_path }}"
        regexp: "^mp0:"  # Assure qu'il n'y a qu'une seule ligne mp0
        state: present
      loop: "{{ groups['lxc_hosts'] }}"
      notify: Restart changed LXC # On notifie un handler pour le redémarrage
      register: mount_results

    # ------------------------------------------------------------------
    # Tâche 3 : Configurer le passthrough GPU/TUN pour servarr (plus robuste)
    # ------------------------------------------------------------------
    - name: "Ensure device passthrough is configured for the servarr LXC"
      ansible.builtin.blockinfile:
        path: "/etc/pve/lxc/{{ vmid.servarr }}.conf"
        state: present
        create: yes  # Crée le fichier s'il n'existe pas (bonne pratique)
        # Le marqueur permet à Ansible de retrouver et gérer ce bloc spécifique
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Servarr Passthrough"
        block: |
          lxc.cgroup2.devices.allow: c 226:0 rwm
          lxc.cgroup2.devices.allow: c 226:128 rwm
          lxc.mount.entry: /dev/dri dev/dri none bind,optional,create=dir
          lxc.cgroup2.devices.allow: c 10:200 rwm
          lxc.mount.entry: /dev/net/tun dev/net/tun none bind,create=file
      notify: Restart servarr LXC
      register: passthrough_result


# ------------------------------------------------------------------
    # Tâche 4 : Configurer les privilèges Docker pour Traefik (Fix v3/Proxmox)
    # ------------------------------------------------------------------
    - name: "Ensure Docker privileges are configured for the Traefik LXC"
      ansible.builtin.blockinfile:
        path: "/etc/pve/lxc/{{ vmid.traefik }}.conf"
        state: present
        create: yes
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Traefik Docker Privileges"
        block: |
          lxc.apparmor.profile: unconfined
          lxc.cgroup2.devices.allow: a
          lxc.cap.drop:
      notify: Restart traefik LXC

    - name: "Ensure /dev/kmsg access for Monitoring LXC (Cadvisor)"
      ansible.builtin.blockinfile:
        path: "/etc/pve/lxc/204.conf"
        state: present
        create: yes
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Monitoring kmsg"
        block: |
          lxc.cgroup2.devices.allow: c 1:11 rwm
          lxc.mount.entry: /dev/kmsg dev/kmsg none bind,create=file
      notify: Restart changed LXC
  # ------------------------------------------------------------------
  # Handlers : Gèrent les redémarrages à la fin du play, seulement si nécessaire
  # ------------------------------------------------------------------
  handlers:
    - name: Restart changed LXC
      ansible.builtin.command:
        cmd: "pct reboot {{ vmid[item.item] }}"
      loop: "{{ mount_results.results }}"
      when: item.changed and item.item != 'servarr' # On ne redémarre pas servarr deux fois
      loop_control:
        label: "Restarting {{ item.item }} due to mount change"
      listen: Restart changed LXC

    - name: Restart servarr LXC
      ansible.builtin.command:
        cmd: "pct reboot {{ vmid.servarr }}"
      listen: Restart servarr LXC
    

    - name: Restart traefik LXC
      ansible.builtin.command:
        cmd: "pct reboot {{ vmid.traefik }}"
      listen: Restart traefik LXC