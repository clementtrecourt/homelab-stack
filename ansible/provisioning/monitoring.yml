---
- name: Deploy Monitoring Stack
  hosts: monitoring
  become: true
  gather_facts: no
  
  tasks:
    - name: Ensure config directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        recurse: yes
      loop:
        - /media/docker-data/prometheus/config
        - /media/docker-data/grafana
    - name: Ensure Grafana data directory permissions
      ansible.builtin.file:
        path: /media/docker-data/grafana
        state: directory
        owner: '472'   # UID spécifique de Grafana
        group: '472'
        mode: '0755'
        recurse: yes

    # Tâche pour Prometheus
    - name: Ensure Prometheus data directory permissions
      ansible.builtin.file:
        path: /media/docker-data/prometheus
        state: directory
        owner: '65534' # UID spécifique de Prometheus (nobody)
        group: '65534'
        mode: '0755'
        recurse: yes
    - name: Copy Prometheus config
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../../docker-compose/lxc-204-monitoring/conf/prometheus.yml"
        dest: /media/docker-data/prometheus/config/prometheus.yml
        mode: '0644'
      notify: Restart Monitoring

    - name: Start Monitoring Stack
      community.docker.docker_compose_v2:
        project_src: '/opt/homelab-stack/docker-compose/lxc-204-monitoring'
        state: present

  handlers:
    - name: Restart Monitoring
      community.docker.docker_compose_v2:
        project_src: '/opt/homelab-stack/docker-compose/lxc-204-monitoring'
        state: restarted