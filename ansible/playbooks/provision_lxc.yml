# ==============================================================================
# Playbook avec modification directe de resolv.conf (méthode de test)
# ==============================================================================

# --- PLAY 1 : PROVISIONING ---
- name: Play 1 - Provisionner un nouveau LXC sur Proxmox
  hosts: proxmox_host
  connection: local
  gather_facts: no
  vars_files:
    - ../credentials.yml

  tasks:
    - name: Assurer que le conteneur LXC existe en clonant le template préparé
      community.proxmox.proxmox:
        api_host: "{{ ansible_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        node: pve
        vmid: 100
        hostname: adguard
        clone: 999
        cores: 1
        memory: 512
        storage: local-lvm
        # Corrected line below
        netif: '{"net0":"name=eth0,gw=192.168.1.254,ip=192.168.1.30/24"}'
        state: present
        features: '{"nesting":1, "keyctl":1}'

    - name: Assurer que le conteneur LXC est démarré
      community.proxmox.proxmox:
        api_host: "{{ ansible_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        node: pve
        vmid: 100
        state: started

    - name: Attendre que le LXC obtienne une adresse IP de Proxmox
      community.proxmox.proxmox_vm_info:
        api_host: "{{ ansible_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        vmid: 100
        network: true
      register: lxc_info
      until: >
        (lxc_info.proxmox_vms[0].network
        | selectattr('name', 'equalto', 'eth0')
        | map(attribute='ip-addresses')
        | first
        | selectattr('ip-address-type', 'equalto', 'inet')
        | list | length) > 0
      retries: 20
      delay: 5

    - name: Ajouter le nouvel LXC à l'inventaire dynamique
      add_host:
        name: "{{ (lxc_info.proxmox_vms[0].network | selectattr('name', 'equalto', 'eth0') | first)['ip-addresses'] | selectattr('ip-address-type', 'equalto', 'inet') | map(attribute='ip-address') | first }}"
        groups: newly_created_lxc
        ansible_user: root
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'

# --- PLAY 2 : CONFIGURATION ---
- name: Play 2 - Configurer le LXC fraîchement créé
  hosts: newly_created_lxc
  remote_user: root
  become: yes

  tasks:
    - name: Attendre que la connexion SSH soit possible
      wait_for_connection:
        timeout: 120

  
    - name: Forcer la configuration du DNS en écrasant /etc/resolv.conf
      ansible.builtin.copy:
        dest: /etc/resolv.conf
        content: |
          nameserver 8.8.8.8
          nameserver 8.8.4.4
          mode: '0644'
         
    - name: Bloc d'installation de Docker Engine
      block:
        - name: Installer les paquets prérequis pour Docker
          ansible.builtin.apt:
            name:
              - apt-transport-https
              - ca-certificates
              - curl
              - gnupg
            state: present
            update_cache: yes

        - name: Créer le répertoire pour la clé GPG de Docker
          ansible.builtin.file:
            path: /etc/apt/keyrings
            state: directory
            mode: '0755'

        - name: Ajouter la clé GPG officielle de Docker
          ansible.builtin.shell:
            cmd: curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            # La commande ne sera pas exécutée si le fichier existe déjà
            creates: /etc/apt/keyrings/docker.gpg

        - name: Ajouter le dépôt APT de Docker
          ansible.builtin.apt_repository:
            repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
            state: present
            filename: docker

        - name: Installer Docker Engine et ses composants
          ansible.builtin.apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
            update_cache: yes
      tags:
        - docker
    - name: Mettre à jour le cache APT sur le nouveau LXC
      ansible.builtin.apt:
        update_cache: yes

    - name: Créer l'utilisateur 'clem' avec le mot de passe 'toor'
      ansible.builtin.user:
        name: clem
        password: "{{ 'toor' | password_hash('sha512') }}"
        shell: /bin/bash
        state: present

    - name: Ajouter 'clem' au groupe sudo pour les privilèges d'administrateur
      ansible.builtin.user:
        name: clem
        groups: sudo,docker
        append: yes

    - name: "Configurer l'accès SSH par clé publique pour l'utilisateur 'clem'"
      ansible.posix.authorized_key:
        # L'utilisateur sur la machine distante pour qui configurer la clé
        user: clem
        # Le contenu de la clé publique à ajouter
        key: "{{ lookup('file', '~/.ssh/id_ed25519.pub') }}"
        # S'assurer que la clé est présente dans le fichier
        state: present
    - name: Installer des paquets de base utiles
      ansible.builtin.apt:
        name:
          - htop
          - btop
          - fastfetch
          - git
          - tree
          - neovim
          - sudo
        state: present

    - name: Afficher un message de succès
      debug:
        msg: "Le LXC {{ inventory_hostname }} est provisionné ET configuré avec succès !"



  handlers:
    - name: Redémarrer le conteneur
      ansible.builtin.reboot:
        msg: "Redémarrage du conteneur pour appliquer la configuration réseau"
        connect_timeout: 5
        reboot_timeout: 300
        pre_reboot_delay: 0
        post_reboot_delay: 30
        test_command: whoami    
