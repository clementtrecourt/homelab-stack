# ==============================================================================
# Playbook avec modification directe de resolv.conf (méthode de test)
# ==============================================================================

# --- PLAY 1 : PROVISIONING ---
- name: Play 1 - Provisionner un nouveau LXC sur Proxmox
  hosts: proxmox_host
  connection: local
  gather_facts: no
  vars_files:
    - ../credentials.yml

  tasks:
    - name: Assurer que le conteneur LXC existe en clonant le template préparé
      community.proxmox.proxmox:
        api_host: "{{ ansible_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        node: pve
        vmid: 700
        hostname: ansible-test-lxc-700
        # On clone le template qui contient déjà openssh-server et votre clé
        clone: 999
        cores: 1
        memory: 512
        storage: local-lvm
        # On demande une configuration simple par DHCP
        netif: '{"net0":"name=eth0,bridge=vmbr0,ip=dhcp"}'
        state: present

    - name: Assurer que le conteneur LXC est démarré
      community.proxmox.proxmox:
        api_host: "{{ ansible_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        node: pve
        vmid: 700
        state: started

    - name: Attendre que le LXC obtienne une adresse IP de Proxmox
      community.proxmox.proxmox_vm_info:
        api_host: "{{ ansible_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        vmid: 700
        network: true
      register: lxc_info
      until: >
        (lxc_info.proxmox_vms[0].network
        | selectattr('name', 'equalto', 'eth0')
        | map(attribute='ip-addresses')
        | first
        | selectattr('ip-address-type', 'equalto', 'inet')
        | list | length) > 0
      retries: 20
      delay: 5

    - name: Ajouter le nouvel LXC à l'inventaire dynamique
      add_host:
        name: "{{ (lxc_info.proxmox_vms[0].network | selectattr('name', 'equalto', 'eth0') | first)['ip-addresses'] | selectattr('ip-address-type', 'equalto', 'inet') | map(attribute='ip-address') | first }}"
        groups: newly_created_lxc
        ansible_user: root
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'

# --- PLAY 2 : CONFIGURATION ---
- name: Play 2 - Configurer le LXC fraîchement créé
  hosts: newly_created_lxc
  remote_user: root
  become: yes

  tasks:
    - name: Attendre que la connexion SSH soit possible
      wait_for_connection:
        timeout: 120

    # === DÉBUT DE VOTRE STRATÉGIE ===
    - name: Forcer la configuration du DNS en écrasant /etc/resolv.conf
      ansible.builtin.copy:
        dest: /etc/resolv.conf
        content: |
          nameserver 8.8.8.8
          nameserver 8.8.4.4
        # On s'assure que le fichier est lisible par tous
        mode: '0644'
    # === FIN DE VOTRE STRATÉGIE ===

    - name: Mettre à jour le cache APT sur le nouveau LXC
      ansible.builtin.apt:
        update_cache: yes

    - name: Installer des paquets de base utiles
      ansible.builtin.apt:
        name:
          - htop
          - fastfetch
          - git
        state: present

    - name: Afficher un message de succès
      debug:
        msg: "Le LXC {{ inventory_hostname }} est provisionné ET configuré avec succès !"